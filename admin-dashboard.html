<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - AIAS Basra</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script type="module" src="js/firestore-api.js"></script>
    <script src="js/main.js" defer></script>
    <style>
        .admin-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem 0; margin-bottom: 2rem; }
        .admin-header .container { display: flex; justify-content: space-between; align-items: center; }
        .admin-header h1 { font-size: 2rem; font-weight: 800; }
        .admin-info { display: flex; align-items: center; gap: 1rem; }
        .logout-btn { padding: 0.5rem 1.5rem; background: rgba(255,255,255,0.2); color: white; border: 2px solid white; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all .3s; }
        .logout-btn:hover { background: white; color: #667eea; }
        .dashboard-nav { margin-bottom: 2rem; }
        .dashboard-nav ul { display: flex; gap: 1rem; list-style: none; padding: 0; border-bottom: 2px solid #e2e8f0; }
        .dashboard-nav li button { padding: 1rem 2rem; background: none; border: none; cursor: pointer; font-size: 1rem; font-weight: 600; color: #718096; transition: all .3s; position: relative; }
        .dashboard-nav li button.active { color: #667eea; }
        .dashboard-nav li button.active::after { content: ''; position: absolute; bottom: -2px; left: 0; right: 0; height: 2px; background: #667eea; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .content-form { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; color: #4a5568; font-size: .9rem; font-weight: 600; margin-bottom: .5rem; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: .75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; font-family: 'Inter', sans-serif; transition: all .3s; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
        .form-group textarea { min-height: 120px; resize: vertical; }
        .submit-btn { padding: 1rem 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all .3s; }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102,126,234,0.3); }
        .message { padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: none; }
        .message.success { background: #f0fff4; color: #38a169; border-left: 4px solid #38a169; }
        .message.error { background: #fff5f5; color: #e53e3e; border-left: 4px solid #e53e3e; }
        .content-list { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .content-item { padding: 1rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; gap: 1rem; }
        .content-item:last-child { border-bottom: none; }
        .btn { padding: .5rem 1rem; border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer; transition: all .2s; }
        .delete-btn { background: #e53e3e; } .delete-btn:hover { background: #c53030; }
        .edit-btn { background: #3182ce; } .edit-btn:hover { background: #2b6cb0; }
        .user-actions { display: flex; gap: .5rem; }
        .home-link { padding: .5rem 1.5rem; background: white; color: #667eea; border: 2px solid white; border-radius: 8px; text-decoration: none; font-weight: 600; transition: all .3s; }
        .home-link:hover { background: rgba(255,255,255,0.9); }
    </style>
</head>
<body>
    <!-- Admin Header -->
    <div class="admin-header">
        <div class="container">
            <h1 data-en="Admin Dashboard" data-ar="ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑÿ•ÿØÿßÿ±Ÿäÿ©">Admin Dashboard</h1>
            <div class="admin-info">
                <button class="language-toggle" id="languageToggle" style="margin-right: 1rem; padding: 0.5rem 1rem; background: rgba(255, 255, 255, 0.2); color: white; border: 2px solid white; border-radius: 8px; display: inline-flex; align-items: center; gap:.5rem;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                    </svg>
                    <span id="currentLang">EN</span>
                </button>
                <span id="adminName"></span>
                <a href="index.html" class="home-link" data-en="View Site" data-ar="ÿπÿ±ÿ∂ ÿßŸÑŸÖŸàŸÇÿπ">View Site</a>
                <button class="logout-btn" onclick="logout()" data-en="Logout" data-ar="ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨">Logout</button>
            </div>
        </div>
    </div>


  <div class="container">
    <div id="message" class="message"></div>

    <nav class="dashboard-nav">
      <ul>
        <li><button onclick="showTab('events')" data-en="Events" data-ar="ÿßŸÑŸÅÿπÿßŸÑŸäÿßÿ™">Events</button></li>
        <li><button onclick="showTab('articles')" data-en="Magazine Articles" data-ar="ŸÖŸÇÿßŸÑÿßÿ™ ÿßŸÑŸÖÿ¨ŸÑÿ©">Magazine Articles</button></li>
        <li><button onclick="showTab('library')" data-en="Library Resources" data-ar="ŸÖŸàÿßÿ±ÿØ ÿßŸÑŸÖŸÉÿ™ÿ®ÿ©">Library Resources</button></li>
        <li><button onclick="showTab('education')" data-en="Education Content" data-ar="ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ™ÿπŸÑŸäŸÖŸä">Education Content</button></li>
        <li><button onclick="showTab('settings')" data-en="‚öôÔ∏è Settings" data-ar="‚öôÔ∏è ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™">‚öôÔ∏è Settings</button></li>
      </ul>
    </nav>

    <!-- Events -->
    <div id="events-tab" class="tab-content">
      <h2>Manage Events</h2>
      <div class="content-list" style="margin-bottom:2rem">
        <h3>Existing Events</h3>
        <div id="existingEventsList"><p>Loading events...</p></div>
      </div>

      <h2>Add New Event</h2>
      <form id="eventForm" class="content-form" data-mode="add">
        <input type="hidden" id="eventId"/>
        <div class="form-group"><label for="eventTitle">Event Title</label><input id="eventTitle" required/></div>
        <div class="form-group"><label for="eventTime">Date and Time</label><input type="datetime-local" id="eventTime" required/></div>
        <div class="form-group"><label for="eventLocation">Location</label><input id="eventLocation" required/></div>
        <div class="form-group">
          <label for="eventType">Event Type</label>
          <select id="eventType" required>
            <option value="Workshop">Workshop</option>
            <option value="Lecture">Lecture</option>
            <option value="Social">Social</option>
          </select>
        </div>
        <div class="form-group"><label for="eventSeats">Available Seats</label><input type="number" id="eventSeats" min="0" value="0" required/></div>
        <div class="form-group"><label for="eventImage">Emoji Icon</label><input id="eventImage" placeholder="üé®" required/></div>
        <div class="form-group"><label for="eventDescription">Description</label><textarea id="eventDescription" required></textarea></div>
        <button type="submit" id="eventSubmitBtn" class="submit-btn">Add Event</button>
      </form>
    </div>

    <!-- Articles (unchanged list; submit handler added in script) -->
    <div id="articles-tab" class="tab-content">
      <h2>Manage Magazine Articles</h2>
      <div class="content-list" style="margin-bottom:2rem">
        <h3>Existing Articles</h3>
        <div id="existingArticlesList"><p>Loading articles...</p></div>
      </div>
      <h2>Add New Article</h2>
      <form id="articleForm" class="content-form" data-mode="add">
        <input type="hidden" id="articleId"/>
        <div class="form-group"><label for="articleTitle">Article Title</label><input id="articleTitle" required/></div>
        <div class="form-group"><label for="articleAuthor">Author Name</label><input id="articleAuthor" required/></div>
        <div class="form-group"><label for="articleDate">Publication Date</label><input type="date" id="articleDate" required/></div>
        <div class="form-group"><label for="articleSummary">Summary</label><textarea id="articleSummary" required></textarea></div>
        <div class="form-group"><label for="articleContent">Full Content</label><textarea id="articleContent" required></textarea></div>
        <button type="submit" id="articleSubmitBtn" class="submit-btn">Add Article</button>
      </form>
    </div>

    <!-- Library -->
    <div id="library-tab" class="tab-content">
      <h2>Manage Library Resources</h2>
      <div class="content-list" style="margin-bottom:2rem">
        <h3>Existing Resources</h3>
        <div id="existingLibraryList"><p>Loading resources...</p></div>
      </div>
      <h2>Add New Library Resource</h2>
      <form id="libraryForm" class="content-form" data-mode="add">
        <input type="hidden" id="libId"/>
        <div class="form-group"><label for="libName">Resource Name</label><input id="libName" required/></div>
        <div class="form-group">
          <label for="libType">Type</label>
          <select id="libType" required>
            <option value="Book">Book</option>
            <option value="Tutorial">Tutorial</option>
            <option value="Software">Software</option>
          </select>
        </div>
        <div class="form-group"><label for="libTags">Tags (comma-separated)</label><input id="libTags" placeholder="Design, Fundamentals, Theory" required/></div>
        <div class="form-group"><label for="libImage">Emoji Icon</label><input id="libImage" placeholder="üìö" required/></div>
        <div class="form-group"><label for="libDescription">Description</label><textarea id="libDescription" required></textarea></div>
        <div class="form-group"><label for="libLink">Download Link</label><input type="url" id="libLink" placeholder="https://" required/></div>
        <button type="submit" id="libSubmitBtn" class="submit-btn">Add Resource</button>
      </form>
    </div>

    <!-- Education (Weekly edit-only, plus Courses and FBD CRUD) -->
    <div id="education-tab" class="tab-content">
      <h2>Education Management</h2>

      <div class="content-form">
        <h3>Weekly Workshop (Edit Only)</h3>
        <form id="educationForm">
          <div class="form-group"><label for="weekTitle">Weekly Workshop Title</label><input id="weekTitle" required/></div>
          <div class="form-group"><label for="lecturerName">Lecturer Name</label><input id="lecturerName" required/></div>
          <div class="form-group"><label for="weekDescription">Workshop Description</label><textarea id="weekDescription" required></textarea></div>
          <button type="submit" class="submit-btn">Update Weekly Workshop</button>
        </form>
      </div>

      <div class="content-form">
        <h3>Courses</h3>
        <div class="content-list" style="margin-bottom:1.5rem">
          <h4>Existing Courses</h4>
          <div id="existingCoursesList"><p>Loading courses...</p></div>
        </div>
        <h4>Add or Edit Course</h4>
        <form id="courseForm" data-mode="add">
          <input type="hidden" id="courseId"/>
          <div class="form-group"><label for="courseTitle">Course Title</label><input id="courseTitle" required/></div>
          <div class="form-group"><label for="courseDescription">Course Description</label><textarea id="courseDescription" required></textarea></div>
          <div class="form-group"><label for="courseLecturer">Lecturer (optional)</label><input id="courseLecturer"/></div>
          <div class="form-group"><label for="courseLink">Link (optional)</label><input id="courseLink" type="url" placeholder="https://"/></div>
          <button type="submit" id="courseSubmitBtn" class="submit-btn">Add Course</button>
        </form>
      </div>

      <div class="content-form">
        <h3>FBD Page</h3>
        <form id="fbdPageForm">
          <div class="form-group"><label for="fbdTitle">Page Title</label><input id="fbdTitle" placeholder="FBD"/></div>
          <div class="form-group"><label for="fbdAbout">About</label><textarea id="fbdAbout" placeholder="About FBD..."></textarea></div>
          <button type="submit" class="submit-btn">Update FBD Page</button>
        </form>
      </div>

      <div class="content-form">
        <h3>FBD Events</h3>
        <div class="content-list" style="margin-bottom:1.5rem">
          <h4>Existing FBD Events</h4>
          <div id="existingFbdEventsList"><p>Loading FBD events...</p></div>
        </div>
        <h4>Add or Edit FBD Event</h4>
        <form id="fbdEventForm" data-mode="add">
          <input type="hidden" id="fbdEventId"/>
          <div class="form-group"><label for="fbdEventTitle">Event Title</label><input id="fbdEventTitle" required/></div>
          <div class="form-group"><label for="fbdEventTime">Date and Time</label><input id="fbdEventTime" type="datetime-local" required/></div>
          <div class="form-group"><label for="fbdEventLocation">Location</label><input id="fbdEventLocation" required/></div>
          <div class="form-group">
            <label for="fbdEventType">Event Type</label>
            <select id="fbdEventType">
              <option value="Workshop">Workshop</option>
              <option value="Lecture">Lecture</option>
              <option value="Social">Social</option>
            </select>
          </div>
          <div class="form-group"><label for="fbdEventSeats">Available Seats</label><input id="fbdEventSeats" type="number" min="0" value="0"/></div>
          <div class="form-group"><label for="fbdEventImage">Emoji Icon</label><input id="fbdEventImage" placeholder="üé®"/></div>
          <div class="form-group"><label for="fbdEventDescription">Description</label><textarea id="fbdEventDescription" required></textarea></div>
          <button type="submit" id="fbdEventSubmitBtn" class="submit-btn">Add FBD Event</button>
        </form>
      </div>
    </div>

    <!-- Settings (unchanged UI, structure fixer used to create missing elements) -->
    <div id="settings-tab" class="tab-content">
      <h2>Firestore Settings</h2>
      <div class="content-form">
        <div id="tokenStatus" style="padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
          <p><strong>Status:</strong> <span id="tokenStatusText">Checking...</span></p>
        </div>
        <p style="color:#4a5568;margin-bottom:1.5rem">Content is now stored in Firebase Firestore. No additional configuration needed.</p>
        <button type="button" class="submit-btn" onclick="testFirestoreConnection()" style="background:#38a169;">Test Connection</button>
      </div>

      <div class="content-form" style="margin-top:2rem">
        <h3>Firestore Structure Management</h3>
        <p style="color:#4a5568;margin-bottom:1.5rem">Validate and fix the Firestore database structure (creates missing docs/collections and migrates legacy).</p>
        <div id="structureResults" style="display:none;padding:1rem;border-radius:8px;margin-bottom:1.5rem;max-height:300px;overflow-y:auto">
          <h4>Structure Validation Results:</h4>
          <div id="structureResultsContent"></div>
        </div>
        <button type="button" class="submit-btn" onclick="fixFirestoreStructure()" style="background:#667eea;">Fix Firestore Structure</button>
      </div>

      <div class="content-form" style="margin-top:2rem">
        <h3>Admin Management</h3>
        <div style="margin-bottom:1.5rem">
          <h4>Current Admins:</h4>
          <div id="adminsList" style="background:#f7fafc;padding:1rem;border-radius:8px;min-height:60px"><p>Loading...</p></div>
        </div>
        <div class="form-group">
          <label for="newAdminEmail">Add Admin Email</label>
          <div style="display:flex;gap:1rem">
            <input id="newAdminEmail" type="email" placeholder="admin@example.com" style="flex:1"/>
            <button type="button" class="submit-btn" onclick="addNewAdmin()" style="flex-shrink:0">Add Admin</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp, getApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import FirestoreAPI from "./js/firestore-api.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAyLFqSWDyLShllJIoqsr2Jjme47OJTPKQ",
      authDomain: "aias-bsr.firebaseapp.com",
      projectId: "aias-bsr",
      storageBucket: "aias-bsr.firebasestorage.app",
      messagingSenderId: "78055223814",
      appId: "1:78055223814:web:99460402c2b1fcd5ae8987",
      measurementId: "G-6W50T4HXDV"
    };

    let app;
    try { app = getApp(); } catch { app = initializeApp(firebaseConfig); }
    const auth = getAuth(app);
    const db = getFirestore(app);
    const firestoreAPI = new FirestoreAPI();

    let CACHE = { events: [], articles: [], library: [], courses: [], fbdEvents: [] };

    window.logout = async function() {
      try {
        await signOut(auth);
        ['aias_authenticated','aias_user_email','aias_user_name','aias_user_picture','aias_is_admin','aias_user_uid'].forEach(localStorage.removeItem.bind(localStorage));
        window.location.href = 'login.html';
      } catch (error) {
        console.error('Logout error:', error);
        alert('Error signing out. Please try again.');
      }
    };

    async function checkIfAdmin(email) {
      try {
        const adminDoc = await getDoc(doc(db, 'config', 'admins'));
        if (adminDoc.exists()) {
          const data = adminDoc.data();
          return Array.isArray(data.admins) && data.admins.includes(email.toLowerCase());
        }
      } catch (error) { console.error('Error checking admin status:', error); }
      return false;
    }

    (function() {
      onAuthStateChanged(auth, async (user) => {
        if (!user) { window.location.href = 'login.html'; return; }
        const isAdmin = await checkIfAdmin(user.email);
        if (!isAdmin) { alert('Access denied. Admin privileges required.'); window.location.href = 'login.html'; return; }
        localStorage.setItem('aias_authenticated','true');
        localStorage.setItem('aias_user_email', user.email);
        localStorage.setItem('aias_user_name', user.displayName || 'Admin');
        localStorage.setItem('aias_user_picture', user.photoURL || '');
        localStorage.setItem('aias_is_admin','true');
        localStorage.setItem('aias_user_uid', user.uid);
        document.getElementById('adminName').textContent = user.displayName || 'Admin';
        showTab('events'); // default
      });
    })();

    function showMessage(text, type) {
      const el = document.getElementById('message');
      el.textContent = text;
      el.className = `message ${type}`;
      el.style.display = 'block';
      setTimeout(()=>{el.style.display='none'}, 5000);
    }
    window.showMessage = showMessage;

    window.reapplyTranslations = function() {
      if (typeof setLanguage === 'function') {
        const lang = localStorage.getItem('language') || 'en';
        setLanguage(lang);
      }
    };

    window.showTab = function(tab) {
      document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.dashboard-nav button').forEach(b=>b.classList.remove('active'));
      document.getElementById(`${tab}-tab`).classList.add('active');
      event?.target?.classList?.add('active');
      if (tab==='events') loadExistingEvents();
      if (tab==='articles') loadExistingArticles();
      if (tab==='library') loadExistingLibraryResources();
      if (tab==='education') { loadEducationContent(); loadCourses(); loadFbd(); }
      if (tab==='settings') { testFirestoreConnection(); loadAdminsList?.(); }
    };

    // Loaders
    window.loadExistingEvents = async function() {
      const box = document.getElementById('existingEventsList');
      box.innerHTML = '<p>Loading events...</p>';
      try {
        const r = await firestoreAPI.getAllContent();
        if (!r.success) throw new Error(r.error);
        CACHE.events = r.content.events || [];
        if (CACHE.events.length===0) { box.innerHTML = '<p>No events found.</p>'; return; }
        box.innerHTML = CACHE.events.map(ev => `
          <div class="content-item">
            <div><strong>${ev.title}</strong><br><small>${new Date(ev.time).toLocaleString()} - ${ev.location}</small></div>
            <div class="user-actions">
              <button class="btn edit-btn" onclick="editEvent('${ev.id}')">Edit</button>
              <button class="btn delete-btn" onclick="deleteEvent('${ev.id}')">Delete</button>
            </div>
          </div>
        `).join('');
        reapplyTranslations();
      } catch (e) { console.error(e); box.innerHTML='<p style="color:red">Error loading events</p>'; }
    };
    window.editEvent = function(id) {
      const ev = CACHE.events.find(x=>x.id===id); if (!ev) return;
      eventForm.dataset.mode = 'edit';
      eventId.value = ev.id;
      eventTitle.value = ev.title || '';
      eventTime.value = ev.time ? new Date(ev.time).toISOString().slice(0,16) : '';
      eventLocation.value = ev.location || '';
      eventType.value = ev.type || 'Workshop';
      eventSeats.value = ev.seats ?? 0;
      eventImage.value = ev.image || '';
      eventDescription.value = ev.description || '';
      eventSubmitBtn.textContent = 'Update Event';
    };
    window.deleteEvent = async function(id) {
      if (!confirm('Are you sure you want to delete this event?')) return;
      const r = await firestoreAPI.deleteEvent(id);
      if (r.success) { showMessage('Event deleted successfully!', 'success'); loadExistingEvents(); }
      else showMessage(r.error || 'Failed to delete event', 'error');
    };

    window.loadExistingArticles = async function() {
      const box = document.getElementById('existingArticlesList');
      box.innerHTML = '<p>Loading articles...</p>';
      try {
        const r = await firestoreAPI.getAllContent();
        if (!r.success) throw new Error(r.error);
        CACHE.articles = r.content.magazine?.articles || [];
        if (CACHE.articles.length===0) { box.innerHTML = '<p>No articles found.</p>'; return; }
        box.innerHTML = CACHE.articles.map(a => `
          <div class="content-item">
            <div><strong>${a.title}</strong><br><small>by ${a.author} - ${a.date}</small></div>
            <div class="user-actions">
              <button class="btn edit-btn" onclick="editArticle('${a.id}')">Edit</button>
              <button class="btn delete-btn" onclick="deleteArticle('${a.id}')">Delete</button>
            </div>
          </div>
        `).join('');
        reapplyTranslations();
      } catch (e) { console.error(e); box.innerHTML='<p style="color:red">Error loading articles</p>'; }
    };
    window.editArticle = function(id) {
      const a = CACHE.articles.find(x=>x.id===id); if (!a) return;
      articleForm.dataset.mode = 'edit';
      articleId.value = a.id;
      articleTitle.value = a.title || '';
      articleAuthor.value = a.author || '';
      articleDate.value = a.date || '';
      articleSummary.value = a.summary || '';
      articleContent.value = a.content || '';
      articleSubmitBtn.textContent = 'Update Article';
    };
    window.deleteArticle = async function(id) {
      if (!confirm('Are you sure you want to delete this article?')) return;
      const r = await firestoreAPI.deleteArticle(id);
      if (r.success) { showMessage('Article deleted successfully!', 'success'); loadExistingArticles(); }
      else showMessage(r.error || 'Failed to delete article', 'error');
    };

    window.loadExistingLibraryResources = async function() {
      const box = document.getElementById('existingLibraryList');
      box.innerHTML = '<p>Loading resources...</p>';
      try {
        const r = await firestoreAPI.getAllContent();
        if (!r.success) throw new Error(r.error);
        CACHE.library = r.content.library || [];
        if (CACHE.library.length===0) { box.innerHTML = '<p>No resources found.</p>'; return; }
        box.innerHTML = CACHE.library.map(it => `
          <div class="content-item">
            <div><strong>${it.name}</strong><br><small>${it.type} - ${(Array.isArray(it.tags)?it.tags.join(', '):it.tags)||''}</small></div>
            <div class="user-actions">
              <button class="btn edit-btn" onclick="editLibrary('${it.id}')">Edit</button>
              <button class="btn delete-btn" onclick="deleteLibraryResource('${it.id}')">Delete</button>
            </div>
          </div>
        `).join('');
        reapplyTranslations();
      } catch (e) { console.error(e); box.innerHTML='<p style="color:red">Error loading resources</p>'; }
    };
    window.editLibrary = function(id) {
      const r = CACHE.library.find(x=>x.id===id); if (!r) return;
      libraryForm.dataset.mode = 'edit';
      libId.value = r.id;
      libName.value = r.name || '';
      libType.value = r.type || 'Book';
      libTags.value = Array.isArray(r.tags) ? r.tags.join(', ') : (r.tags || '');
      libImage.value = r.image || '';
      libDescription.value = r.description || '';
      libLink.value = r.link || '';
      libSubmitBtn.textContent = 'Update Resource';
    };
    window.deleteLibraryResource = async function(id) {
      if (!confirm('Are you sure you want to delete this resource?')) return;
      const r = await firestoreAPI.deleteLibraryResource(id);
      if (r.success) { showMessage('Resource deleted successfully!', 'success'); loadExistingLibraryResources(); }
      else showMessage(r.error || 'Failed to delete resource', 'error');
    };

    // Courses and FBD
    window.loadEducationContent = async function() {
      try {
        const r = await firestoreAPI.getAllContent();
        const w = r.success ? r.content.education?.weeklyWorkshop : null;
        if (w) { weekTitle.value = w.weekTitle || ''; lecturerName.value = w.lecturerName || ''; weekDescription.value = w.description || ''; }
      } catch (e) { console.error(e); }
    };
    window.loadCourses = async function() {
      const box = document.getElementById('existingCoursesList');
      box.innerHTML = '<p>Loading courses...</p>';
      try {
        const r = await firestoreAPI.getAllContent();
        if (!r.success) throw new Error(r.error);
        CACHE.courses = r.content.education?.courses || [];
        if (CACHE.courses.length===0) { box.innerHTML = '<p>No courses found.</p>'; return; }
        box.innerHTML = CACHE.courses.map(c => `
          <div class="content-item">
            <div><strong>${c.title}</strong><br><small>${c.lecturer ? c.lecturer+' ‚Äî ' : ''}${c.link ? `<a href="${c.link}" target="_blank">Link</a>` : ''}</small></div>
            <div class="user-actions">
              <button class="btn edit-btn" onclick="editCourse('${c.id}')">Edit</button>
              <button class="btn delete-btn" onclick="deleteCourse('${c.id}')">Delete</button>
            </div>
          </div>
        `).join('');
      } catch (e) { console.error(e); box.innerHTML = '<p style="color:red">Error loading courses</p>'; }
    };
    window.editCourse = function(id) {
      const c = CACHE.courses.find(x=>x.id===id); if (!c) return;
      courseForm.dataset.mode = 'edit';
      courseId.value = c.id;
      courseTitle.value = c.title || '';
      courseDescription.value = c.description || '';
      courseLecturer.value = c.lecturer || '';
      courseLink.value = c.link || '';
      courseSubmitBtn.textContent = 'Update Course';
    };
    window.deleteCourse = async function(id) {
      if (!confirm('Are you sure you want to delete this course?')) return;
      const r = await firestoreAPI.deleteCourse(id);
      if (r.success) { showMessage('Course deleted', 'success'); loadCourses(); }
      else showMessage(r.error || 'Failed to delete course', 'error');
    };

    window.loadFbd = async function() {
      const box = document.getElementById('existingFbdEventsList');
      box.innerHTML = '<p>Loading FBD events...</p>';
      try {
        const r = await firestoreAPI.getAllContent();
        if (!r.success) throw new Error(r.error);
        const fbd = r.content.education?.fbd || { pageTitle:'', about:'', events:[] };
        fbdTitle.value = fbd.pageTitle || '';
        fbdAbout.value = fbd.about || '';
        CACHE.fbdEvents = fbd.events || [];
        if (CACHE.fbdEvents.length===0) { box.innerHTML = '<p>No FBD events found.</p>'; return; }
        box.innerHTML = CACHE.fbdEvents.map(ev => `
          <div class="content-item">
            <div><strong>${ev.title}</strong><br><small>${new Date(ev.time).toLocaleString()} - ${ev.location}</small></div>
            <div class="user-actions">
              <button class="btn edit-btn" onclick="editFbdEvent('${ev.id}')">Edit</button>
              <button class="btn delete-btn" onclick="deleteFbdEvent('${ev.id}')">Delete</button>
            </div>
          </div>
        `).join('');
      } catch (e) { console.error(e); box.innerHTML = '<p style="color:red">Error loading FBD</p>'; }
    };
    window.editFbdEvent = function(id) {
      const ev = CACHE.fbdEvents.find(x=>x.id===id); if (!ev) return;
      fbdEventForm.dataset.mode = 'edit';
      fbdEventId.value = ev.id;
      fbdEventTitle.value = ev.title || '';
      fbdEventTime.value = ev.time ? new Date(ev.time).toISOString().slice(0,16) : '';
      fbdEventLocation.value = ev.location || '';
      fbdEventType.value = ev.type || 'Workshop';
      fbdEventSeats.value = ev.seats ?? 0;
      fbdEventImage.value = ev.image || '';
      fbdEventDescription.value = ev.description || '';
      fbdEventSubmitBtn.textContent = 'Update FBD Event';
    };
    window.deleteFbdEvent = async function(id) {
      if (!confirm('Are you sure you want to delete this FBD event?')) return;
      const r = await firestoreAPI.deleteFbdEvent(id);
      if (r.success) { showMessage('FBD event deleted', 'success'); loadFbd(); }
      else showMessage(r.error || 'Failed to delete FBD event', 'error');
    };

    // Submit handlers (this fixes ‚Äúnothing happens‚Äù)
    const eventForm = document.getElementById('eventForm');
    const eventId = document.getElementById('eventId');
    const eventTitle = document.getElementById('eventTitle');
    const eventTime = document.getElementById('eventTime');
    const eventLocation = document.getElementById('eventLocation');
    const eventType = document.getElementById('eventType');
    const eventSeats = document.getElementById('eventSeats');
    const eventImage = document.getElementById('eventImage');
    const eventDescription = document.getElementById('eventDescription');
    const eventSubmitBtn = document.getElementById('eventSubmitBtn');

    eventForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const mode = eventForm.dataset.mode || 'add';
      const payload = {
        title: eventTitle.value.trim(),
        time: new Date(eventTime.value).toISOString(),
        location: eventLocation.value.trim(),
        type: eventType.value,
        seats: parseInt(eventSeats.value || '0', 10),
        image: eventImage.value.trim(),
        description: eventDescription.value.trim()
      };
      const r = mode==='edit'
        ? await firestoreAPI.updateEvent(eventId.value, payload)
        : await firestoreAPI.addEvent(payload);
      if (r.success) {
        showMessage('Event saved successfully!', 'success');
        eventForm.reset();
        eventForm.dataset.mode = 'add';
        eventSubmitBtn.textContent = 'Add Event';
        loadExistingEvents();
      } else {
        showMessage(r.error || 'Failed to save event', 'error');
      }
    });

    const articleForm = document.getElementById('articleForm');
    const articleId = document.getElementById('articleId');
    const articleTitle = document.getElementById('articleTitle');
    const articleAuthor = document.getElementById('articleAuthor');
    const articleDate = document.getElementById('articleDate');
    const articleSummary = document.getElementById('articleSummary');
    const articleContent = document.getElementById('articleContent');
    const articleSubmitBtn = document.getElementById('articleSubmitBtn');

    articleForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const mode = articleForm.dataset.mode || 'add';
      const payload = {
        title: articleTitle.value.trim(),
        author: articleAuthor.value.trim(),
        date: articleDate.value,
        summary: articleSummary.value.trim(),
        content: articleContent.value.trim()
      };
      const r = mode==='edit'
        ? await firestoreAPI.updateArticle(articleId.value, payload)
        : await firestoreAPI.addArticle(payload);
      if (r.success) {
        showMessage('Article saved successfully!', 'success');
        articleForm.reset();
        articleForm.dataset.mode = 'add';
        articleSubmitBtn.textContent = 'Add Article';
        loadExistingArticles();
      } else {
        showMessage(r.error || 'Failed to save article', 'error');
      }
    });

    const libraryForm = document.getElementById('libraryForm');
    const libId = document.getElementById('libId');
    const libName = document.getElementById('libName');
    const libType = document.getElementById('libType');
    const libTags = document.getElementById('libTags');
    const libImage = document.getElementById('libImage');
    const libDescription = document.getElementById('libDescription');
    const libLink = document.getElementById('libLink');
    const libSubmitBtn = document.getElementById('libSubmitBtn');

    libraryForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const mode = libraryForm.dataset.mode || 'add';
      const payload = {
        name: libName.value.trim(),
        type: libType.value,
        tags: libTags.value ? libTags.value.split(',').map(t=>t.trim()).filter(Boolean) : [],
        image: libImage.value.trim(),
        description: libDescription.value.trim(),
        link: libLink.value.trim()
      };
      const r = mode==='edit'
        ? await firestoreAPI.updateLibraryResource(libId.value, payload)
        : await firestoreAPI.addLibraryResource(payload);
      if (r.success) {
        showMessage('Resource saved successfully!', 'success');
        libraryForm.reset();
        libraryForm.dataset.mode = 'add';
        libSubmitBtn.textContent = 'Add Resource';
        loadExistingLibraryResources();
      } else {
        showMessage(r.error || 'Failed to save resource', 'error');
      }
    });

    const educationForm = document.getElementById('educationForm');
    const weekTitle = document.getElementById('weekTitle');
    const lecturerName = document.getElementById('lecturerName');
    const weekDescription = document.getElementById('weekDescription');

    educationForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = {
        weekTitle: weekTitle.value.trim(),
        lecturerName: lecturerName.value.trim(),
        description: weekDescription.value.trim()
      };
      const r = await firestoreAPI.updateEducation(payload);
      if (r.success) showMessage('Education content updated!', 'success');
      else showMessage(r.error || 'Failed to update education content', 'error');
    });

    const courseForm = document.getElementById('courseForm');
    const courseId = document.getElementById('courseId');
    const courseTitle = document.getElementById('courseTitle');
    const courseDescription = document.getElementById('courseDescription');
    const courseLecturer = document.getElementById('courseLecturer');
    const courseLink = document.getElementById('courseLink');
    const courseSubmitBtn = document.getElementById('courseSubmitBtn');

    courseForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const mode = courseForm.dataset.mode || 'add';
      const payload = {
        title: courseTitle.value.trim(),
        description: courseDescription.value.trim(),
        lecturer: courseLecturer.value.trim(),
        link: courseLink.value.trim()
      };
      const r = mode==='edit'
        ? await firestoreAPI.updateCourse(courseId.value, payload)
        : await firestoreAPI.addCourse(payload);
      if (r.success) {
        showMessage('Course saved', 'success');
        courseForm.reset();
        courseForm.dataset.mode = 'add';
        courseSubmitBtn.textContent = 'Add Course';
        loadCourses();
      } else {
        showMessage(r.error || 'Failed to save course', 'error');
      }
    });

    const fbdPageForm = document.getElementById('fbdPageForm');
    const fbdTitle = document.getElementById('fbdTitle');
    const fbdAbout = document.getElementById('fbdAbout');

    fbdPageForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const r = await firestoreAPI.updateFbdPage({
        pageTitle: fbdTitle.value.trim(),
        about: fbdAbout.value.trim()
      });
      if (r.success) showMessage('FBD page updated', 'success');
      else showMessage(r.error || 'Failed to update FBD page', 'error');
    });

    const fbdEventForm = document.getElementById('fbdEventForm');
    const fbdEventId = document.getElementById('fbdEventId');
    const fbdEventTitle = document.getElementById('fbdEventTitle');
    const fbdEventTime = document.getElementById('fbdEventTime');
    const fbdEventLocation = document.getElementById('fbdEventLocation');
    const fbdEventType = document.getElementById('fbdEventType');
    const fbdEventSeats = document.getElementById('fbdEventSeats');
    const fbdEventImage = document.getElementById('fbdEventImage');
    const fbdEventDescription = document.getElementById('fbdEventDescription');
    const fbdEventSubmitBtn = document.getElementById('fbdEventSubmitBtn');

    fbdEventForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const mode = fbdEventForm.dataset.mode || 'add';
      const payload = {
        title: fbdEventTitle.value.trim(),
        time: new Date(fbdEventTime.value).toISOString(),
        location: fbdEventLocation.value.trim(),
        type: fbdEventType.value,
        seats: parseInt(fbdEventSeats.value || '0', 10),
        image: fbdEventImage.value.trim(),
        description: fbdEventDescription.value.trim()
      };
      const r = mode==='edit'
        ? await firestoreAPI.updateFbdEvent(fbdEventId.value, payload)
        : await firestoreAPI.addFbdEvent(payload);
      if (r.success) {
        showMessage('FBD event saved', 'success');
        fbdEventForm.reset();
        fbdEventForm.dataset.mode = 'add';
        fbdEventSubmitBtn.textContent = 'Add FBD Event';
        loadFbd();
      } else {
        showMessage(r.error || 'Failed to save FBD event', 'error');
      }
    });

    // Settings helpers
    window.testFirestoreConnection = async function() {
      const el = document.getElementById('tokenStatusText');
      el.textContent = 'Testing...';
      const r = await firestoreAPI.testConnection();
      el.textContent = r.success ? 'Connected' : `Error: ${r.error}`;
      document.getElementById('tokenStatus').style.background = r.success ? '#f0fff4' : '#fff5f5';
    };
    window.fixFirestoreStructure = async function() {
      const box = document.getElementById('structureResults');
      const content = document.getElementById('structureResultsContent');
      box.style.display = 'block';
      content.innerHTML = '<p>Validating and fixing structure...</p>';
      const r = await firestoreAPI.validateAndFixStructure();
      const actions = (r.actions||[]).map(a=>`<li style="color:#2f855a">‚úì ${a}</li>`).join('');
      const errors  = (r.errors ||[]).map(e=>`<li style="color:#c53030">‚úó ${e}</li>`).join('');
      content.innerHTML = `<ul>${actions}${errors}</ul>`;
    };
    window.loadAdminsList = async function() {
      const box = document.getElementById('adminsList'); box.innerHTML = '<p>Loading...</p>';
      const r = await firestoreAPI.getAdmins();
      if (!r.success) { box.innerHTML = `<p style="color:red">${r.error}</p>`; return; }
      if ((r.admins||[]).length===0) { box.innerHTML = '<p>No admins found.</p>'; return; }
      box.innerHTML = r.admins.map(a=>`<div class="content-item"><div>${a}</div></div>`).join('');
    };
  </script>
</body>
</html>
