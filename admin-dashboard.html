<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard - AIAS Basra</title>
  <link rel="icon" type="image/png" href="static/images/branding/LOGO.png"/>
  <link rel="stylesheet" href="css/style.css"/>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <script type="module" src="js/firestore-api.js"></script>
  <script src="js/main.js" defer></script>
  <style>
    :root {
      --bg: #f7fafc;
      --panel: #ffffff;
      --text: #1a202c;
      --muted: #4a5568;
      --border: #e2e8f0;
      --brand1: #667eea;
      --brand2: #764ba2;
      --success: #38a169;
      --error: #e53e3e;
    }
    body { background: var(--bg); font-family: 'Inter', sans-serif; }
    .admin-header { background: linear-gradient(135deg, var(--brand1) 0%, var(--brand2) 100%); color: white; padding: 1.25rem 0; margin-bottom: 0; }
    .admin-header .container { display: flex; justify-content: space-between; align-items: center; gap: 1rem; }
    .admin-header h1 { font-size: 1.4rem; font-weight: 800; margin: 0; }
    .admin-info { display: flex; align-items: center; gap: .5rem; }
    .logout-btn, .home-link, .language-toggle { padding: 0.35rem 0.9rem; background: rgba(255,255,255,0.2); color: white; border: 2px solid white; border-radius: 8px; cursor: pointer; font-weight: 600; font-size:.85rem; text-decoration:none; }
    .logout-btn:hover, .home-link:hover, .language-toggle:hover { background: white; color: var(--brand1); }
    .dashboard { display: grid; grid-template-columns: 260px 1fr; gap: 1.25rem; padding: 1.25rem; }
    .sidebar { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; height: calc(100vh - 130px); position: sticky; top: 1.25rem; }
    .sidebar h3 { margin: 0; padding: 1rem 1rem .25rem; font-size: .9rem; color: var(--muted); text-transform: uppercase; letter-spacing: .06em; }
    .nav { list-style: none; margin: 0; padding: .5rem; }
    .nav li { margin: .25rem 0; }
    .nav button { width: 100%; text-align: left; background: none; border: none; border-radius: 10px; padding: .65rem .8rem; font-weight: 600; color: #4a5568; cursor: pointer; font-size:.9rem; }
    .nav button.active, .nav button:hover { background: #eef2ff; color: var(--brand1); }
    .content { min-height: 70vh; }
    .content > .tab-content { display: none; }
    .content > .tab-content.active { display: block; }
    .top-actions { display:flex; justify-content:flex-end; gap:.5rem; margin-bottom: .75rem; }
    .mini-btn { border: 1px solid var(--border); background: var(--panel); color: var(--muted); border-radius: 8px; padding: .35rem .6rem; cursor: pointer; font-size: .75rem; font-weight:600; }
    .mini-btn:hover { background: #edf2f7; color: var(--text); }
    .panel { background: var(--panel); padding: 1rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .message { padding: .75rem 1rem; border-radius: 8px; margin-bottom: 1rem; display: none; border-left: 4px solid transparent; font-size:.9rem; }
    .message.success { background: #f0fff4; color: var(--success); border-left-color: var(--success); }
    .message.error { background: #fff5f5; color: var(--error); border-left-color: var(--error); }
    details.accordion { border: 1px solid var(--border); border-radius: 12px; background: var(--panel); margin-bottom: .75rem; overflow: hidden; }
    details.accordion > summary { list-style: none; cursor: pointer; padding: .85rem 1rem; font-weight: 700; display:flex; align-items:center; justify-content:space-between; font-size:.95rem; }
    details.accordion > summary::-webkit-details-marker { display:none; }
    details.accordion[open] > summary { background: #f8fafc; border-bottom: 1px solid var(--border); }
    .accordion-body { padding: 1rem; }
    .content-list .content-item { padding: .75rem; border-bottom: 1px solid var(--border); display:flex; justify-content:space-between; align-items:center; gap: .75rem; font-size:.85rem; }
    .content-list .content-item:last-child { border-bottom: none; }
    .btn { padding: .45rem .7rem; border: none; border-radius: 8px; color: white; font-weight: 700; cursor: pointer; font-size:.75rem; }
    .delete-btn { background: var(--error); } .delete-btn:hover { filter: brightness(0.95); }
    .edit-btn { background: #3182ce; } .edit-btn:hover { filter: brightness(0.95); }
    .submit-btn { padding: .75rem 1.2rem; background: linear-gradient(135deg, var(--brand1) 0%, var(--brand2) 100%); color: white; border: none; border-radius: 10px; font-size: .95rem; font-weight: 700; cursor: pointer; transition:.25s; }
    .submit-btn:hover { transform: translateY(-1px); box-shadow: 0 10px 20px rgba(102,126,234,0.25); }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; color: var(--muted); font-size: .75rem; font-weight: 700; margin-bottom: .35rem; letter-spacing:.5px; }
    .form-group input, .form-group textarea, .form-group select { width: 100%; padding: .6rem .65rem; border: 2px solid var(--border); border-radius: 8px; font-size: .85rem; font-family: inherit; background:white; }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: var(--brand1); box-shadow: 0 0 0 3px rgba(102,126,234,0.12); }
    .form-group textarea { min-height: 110px; resize: vertical; }
    .two-col { display:grid; grid-template-columns: 1fr 1fr; gap: .75rem; }
    .error-box { display:none; background:#fff5f5; border:1px solid #feb2b2; color:#c53030; padding:.75rem .9rem; border-radius:8px; margin-bottom:.85rem; font-size:.75rem; line-height:1.4; }
    .error-box ul { margin:0; padding-left:1.05rem; }
    @media (max-width: 900px) {
      .dashboard { grid-template-columns: 1fr; }
      .sidebar { position: static; height: auto; }
      .two-col { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- Admin Header -->
  <div class="admin-header">
    <div class="container">
      <h1 data-en="Admin Dashboard" data-ar="Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©">Admin Dashboard</h1>
      <div class="admin-info">
        <button class="language-toggle" id="languageToggle" style="display:inline-flex;align-items:center;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;">
            <circle cx="12" cy="12" r="10"/>
            <path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
          </svg>
          <span id="currentLang">EN</span>
        </button>
        <a href="index.html" class="home-link" data-en="View Site" data-ar="Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆÙ‚Ø¹">View Site</a>
        <button class="logout-btn" onclick="logout()" data-en="Logout" data-ar="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬">Logout</button>
      </div>
    </div>
  </div>

  <div class="dashboard">
    <!-- Sidebar -->
    <aside class="sidebar">
      <h3 data-en="Navigate" data-ar="Ø§Ù„ØªÙ†Ù‚Ù„">Navigate</h3>
      <ul class="nav" id="mainNav">
        <li><button data-tab="events" class="active" data-en="Events" data-ar="Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª">Events</button></li>
        <li><button data-tab="articles" data-en="Magazine" data-ar="Ø§Ù„Ù…Ø¬Ù„Ø©">Magazine</button></li>
        <li><button data-tab="library" data-en="Library" data-ar="Ø§Ù„Ù…ÙƒØªØ¨Ø©">Library</button></li>
        <li><button data-tab="education" data-en="Education" data-ar="Ø§Ù„ØªØ¹Ù„ÙŠÙ…">Education</button></li>
        <li><button data-tab="fbd" data-en="FBD" data-ar="FBD">FBD</button></li>
        <li><button data-tab="settings" data-en="Settings" data-ar="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª">Settings</button></li>
      </ul>
    </aside>

    <!-- Main content -->
    <main class="content">
      <div id="message" class="message"></div>

      <!-- Top actions -->
      <div class="top-actions">
        <button id="expandAll" class="mini-btn" data-en="Expand all" data-ar="ØªÙˆØ³ÙŠØ¹ Ø§Ù„ÙƒÙ„">Expand all</button>
        <button id="collapseAll" class="mini-btn" data-en="Collapse all" data-ar="Ø·ÙŠ Ø§Ù„ÙƒÙ„">Collapse all</button>
      </div>

      <!-- Events -->
      <section id="events-tab" class="tab-content active">
        <details class="accordion" open>
          <summary data-en="Existing Events" data-ar="Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©">Existing Events</summary>
          <div class="accordion-body panel">
            <div id="existingEventsList"><p>Loading events...</p></div>
          </div>
        </details>

        <details class="accordion" open>
          <summary data-en="Add or Edit Event" data-ar="Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ ÙØ¹Ø§Ù„ÙŠØ©">Add or Edit Event</summary>
          <div class="accordion-body panel">
            <form id="eventForm" data-mode="add" novalidate>
              <input type="hidden" id="eventId"/>
              <div class="two-col">
                <div class="form-group">
                  <label for="eventTitle" data-en="Event Title" data-ar="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ©">Event Title</label>
                  <input id="eventTitle" name="title" required autocomplete="off"/>
                </div>
                <div class="form-group">
                  <label for="eventTime" data-en="Date and Time" data-ar="Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª">Date and Time</label>
                  <input type="datetime-local" id="eventTime" name="time" required/>
                </div>
              </div>
              <div class="two-col">
                <div class="form-group">
                  <label for="eventLocation" data-en="Location" data-ar="Ø§Ù„Ù…ÙˆÙ‚Ø¹">Location</label>
                  <input id="eventLocation" name="location" required/>
                </div>
                <div class="form-group">
                  <label for="eventType" data-en="Event Type" data-ar="Ù†ÙˆØ¹ Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ©">Event Type</label>
                  <select id="eventType" name="type" required>
                    <!-- Options loaded dynamically from categories-loader -->
                  </select>
                </div>
              </div>
              <div class="two-col">
                <div class="form-group">
                  <label for="eventSeats" data-en="Available Seats" data-ar="Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø©">Available Seats</label>
                  <input type="number" id="eventSeats" name="seats" min="1" value="10" required/>
                </div>
                <div class="form-group">
                  <label for="eventImage" data-en="Emoji Icon" data-ar="Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ">Emoji Icon</label>
                  <input id="eventImage" name="image" placeholder="ðŸŽ¨" required/>
                </div>
                <div class="form-group">
                  <label for="eventImageUrl" data-en="Image URL (Optional)" data-ar="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">Image URL (Optional)</label>
                  <input id="eventImageUrl" name="imageUrl" type="url" placeholder="https://example.com/image.jpg"/>
                </div>
                <div class="form-group">
                  <label for="eventRegisterUrl" data-en="Register Button URL (Optional)" data-ar="Ø±Ø§Ø¨Ø· Ø²Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">Register Button URL (Optional)</label>
                  <input id="eventRegisterUrl" name="registerUrl" type="url" placeholder="https://example.com/register"/>
                </div>
                <div class="form-group">
                  <label for="eventDetailsUrl" data-en="Details Button URL (Optional)" data-ar="Ø±Ø§Ø¨Ø· Ø²Ø± Ø§Ù„ØªÙØ§ØµÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">Details Button URL (Optional)</label>
                  <input id="eventDetailsUrl" name="detailsUrl" type="url" placeholder="https://example.com/details"/>
                </div>
                <div class="form-group">
                  <label for="eventGalleryUrl" data-en="Gallery Button URL (Optional)" data-ar="Ø±Ø§Ø¨Ø· Ø²Ø± Ø§Ù„Ù…Ø¹Ø±Ø¶ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">Gallery Button URL (Optional)</label>
                  <input id="eventGalleryUrl" name="galleryUrl" type="url" placeholder="https://example.com/gallery"/>
                </div>
              </div>
              <div class="form-group">
                <label for="eventDescription" data-en="Description" data-ar="Ø§Ù„ÙˆØµÙ">Description</label>
                <textarea id="eventDescription" name="description" required></textarea>
              </div>
              <div id="eventErrors" class="error-box"></div>
              <button type="submit" id="eventSubmitBtn" class="submit-btn" data-en="Add Event" data-ar="Ø¥Ø¶Ø§ÙØ© ÙØ¹Ø§Ù„ÙŠØ©">Add Event</button>
            </form>
          </div>
        </details>
      </section>

      <!-- Articles -->
      <section id="articles-tab" class="tab-content">
        <details class="accordion" open>
          <summary data-en="Existing Articles" data-ar="Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©">Existing Articles</summary>
          <div class="accordion-body panel">
            <div id="existingArticlesList"><p>Loading articles...</p></div>
          </div>
        </details>

        <details class="accordion" open>
          <summary data-en="Add or Edit Article" data-ar="Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ Ù…Ù‚Ø§Ù„">Add or Edit Article</summary>
          <div class="accordion-body panel">
            <form id="articleForm" data-mode="add" novalidate>
              <input type="hidden" id="articleId"/>
              <div class="two-col">
                <div class="form-group"><label for="articleTitle" data-en="Article Title" data-ar="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‚Ø§Ù„">Article Title</label><input id="articleTitle" name="title" required/></div>
                <div class="form-group"><label for="articleAuthor" data-en="Author Name" data-ar="Ø§Ø³Ù… Ø§Ù„ÙƒØ§ØªØ¨">Author Name</label><input id="articleAuthor" name="author" required/></div>
              </div>
              <div class="two-col">
                <div class="form-group"><label for="articleDate" data-en="Publication Date" data-ar="ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø´Ø±">Publication Date</label><input type="date" id="articleDate" name="date" required/></div>
                <div class="form-group"><label for="articleSummary" data-en="Summary" data-ar="Ø§Ù„Ù…Ù„Ø®Øµ">Summary</label><input id="articleSummary" name="summary" required/></div>
              </div>
              <div class="form-group">
                <label for="articleImageUrl" data-en="Image URL (Optional)" data-ar="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">Image URL (Optional)</label>
                <input type="url" id="articleImageUrl" name="imageUrl" placeholder="https://example.com/image.jpg"/>
              </div>
              <div class="form-group">
                <label for="articleReadMoreUrl" data-en="Read More Button URL (Optional)" data-ar="Ø±Ø§Ø¨Ø· Ø²Ø± Ø§Ù‚Ø±Ø£ Ø§Ù„Ù…Ø²ÙŠØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">Read More Button URL (Optional)</label>
                <input type="url" id="articleReadMoreUrl" name="readMoreUrl" placeholder="https://example.com/article"/>
              </div>
              <div class="form-group"><label for="articleContent" data-en="Full Content" data-ar="Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙƒØ§Ù…Ù„">Full Content</label><textarea id="articleContent" name="content" required></textarea></div>
              <div id="articleErrors" class="error-box"></div>
              <button type="submit" id="articleSubmitBtn" class="submit-btn" data-en="Add Article" data-ar="Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø§Ù„">Add Article</button>
            </form>
          </div>
        </details>
      </section>

      <!-- Library -->
      <section id="library-tab" class="tab-content">
        <details class="accordion" open>
          <summary data-en="Existing Resources" data-ar="Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠØ©">Existing Resources</summary>
          <div class="accordion-body panel">
            <div id="existingLibraryList"><p>Loading resources...</p></div>
          </div>
        </details>

        <details class="accordion" open>
          <summary data-en="Add or Edit Resource" data-ar="Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ Ù…ØµØ¯Ø±">Add or Edit Resource</summary>
          <div class="accordion-body panel">
            <form id="libraryForm" data-mode="add" novalidate>
              <input type="hidden" id="libId"/>
              <div class="two-col">
                <div class="form-group"><label for="libName" data-en="Resource Name" data-ar="Ø§Ø³Ù… Ø§Ù„Ù…ØµØ¯Ø±">Resource Name</label><input id="libName" name="name" required/></div>
                <div class="form-group">
                  <label for="libType" data-en="Type" data-ar="Ø§Ù„Ù†ÙˆØ¹">Type</label>
                  <select id="libType" name="type" required>
                    <option value="Book">Book</option>
                    <option value="Tutorial">Tutorial</option>
                    <option value="Software">Software</option>
                  </select>
                </div>
              </div>
              <div class="two-col">
                <div class="form-group">
                  <label for="libCategory" data-en="Category" data-ar="Ø§Ù„ÙØ¦Ø©">Category</label>
                  <select id="libCategory" name="category" required>
                    <!-- Options loaded dynamically from categories-loader -->
                  </select>
                </div>
                <div class="form-group"><label for="libImage" data-en="Emoji Icon" data-ar="Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ">Emoji Icon</label><input id="libImage" name="image" placeholder="ðŸ“š" required/></div>
              </div>
              <div class="two-col">
                <div class="form-group"><label for="libTags" data-en="Tags (comma-separated)" data-ar="Ø§Ù„ÙˆØ³ÙˆÙ… (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙÙˆØ§ØµÙ„)">Tags (comma-separated)</label><input id="libTags" name="tags" placeholder="Design, Fundamentals, Theory" required/></div>
                <div class="form-group"><label for="libImageUrl" data-en="Image URL (Optional)" data-ar="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">Image URL (Optional)</label><input type="url" id="libImageUrl" name="imageUrl" placeholder="https://example.com/image.jpg"/></div>
              </div>
              <div class="two-col">
                <div class="form-group"><label for="libDescription" data-en="Description" data-ar="Ø§Ù„ÙˆØµÙ">Description</label><input id="libDescription" name="description" required/></div>
                <div class="form-group"><label for="libLink" data-en="Download Link" data-ar="Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙ†Ø²ÙŠÙ„">Download Link</label><input type="url" id="libLink" name="link" placeholder="https://" required/></div>
              </div>
              <div id="libraryErrors" class="error-box"></div>
              <button type="submit" id="libSubmitBtn" class="submit-btn" data-en="Add Resource" data-ar="Ø¥Ø¶Ø§ÙØ© Ù…ØµØ¯Ø±">Add Resource</button>
            </form>
          </div>
        </details>
      </section>

      <!-- Education -->
      <section id="education-tab" class="tab-content">
        <details class="accordion" open>
          <summary data-en="Weekly Workshop" data-ar="Ø§Ù„ÙˆØ±Ø´Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©">Weekly Workshop</summary>
          <div class="accordion-body panel">
            <form id="educationForm" novalidate>
              <div class="two-col">
                <div class="form-group"><label for="weekTitle" data-en="Weekly Workshop Title" data-ar="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ±Ø´Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©">Weekly Workshop Title</label><input id="weekTitle" name="weekTitle" required/></div>
                <div class="form-group"><label for="lecturerName" data-en="Lecturer Name" data-ar="Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø§Ø¶Ø±">Lecturer Name</label><input id="lecturerName" name="lecturerName" required/></div>
              </div>
              <div class="form-group"><label for="weekDescription" data-en="Workshop Description" data-ar="ÙˆØµÙ Ø§Ù„ÙˆØ±Ø´Ø©">Workshop Description</label><textarea id="weekDescription" name="description" required></textarea></div>
              <div class="form-group">
                <label for="workshopUrl" data-en="Workshop Button URL (Optional)" data-ar="Ø±Ø§Ø¨Ø· Ø²Ø± Ø§Ù„ÙˆØ±Ø´Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">Workshop Button URL (Optional)</label>
                <input type="url" id="workshopUrl" name="workshopUrl" placeholder="https://example.com/join-workshop"/>
              </div>
              <div id="educationErrors" class="error-box"></div>
              <button type="submit" class="submit-btn" data-en="Update Weekly Workshop" data-ar="ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ±Ø´Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©">Update Weekly Workshop</button>
            </form>
          </div>
        </details>

        <details class="accordion" open>
          <summary data-en="Courses" data-ar="Ø§Ù„Ø¯ÙˆØ±Ø§Øª">Courses</summary>
          <div class="accordion-body panel">
            <div class="panel" style="margin-bottom: .75rem">
              <h4 style="margin-top:0" data-en="Existing Courses" data-ar="Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©">Existing Courses</h4>
              <div id="existingCoursesList"><p>Loading courses...</p></div>
            </div>
            <form id="courseForm" data-mode="add" novalidate>
              <input type="hidden" id="courseId"/>
              <div class="two-col">
                <div class="form-group"><label for="courseTitle" data-en="Course Title" data-ar="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯ÙˆØ±Ø©">Course Title</label><input id="courseTitle" name="title" required/></div>
                <div class="form-group"><label for="courseLecturer" data-en="Lecturer (optional)" data-ar="Ø§Ù„Ù…Ø­Ø§Ø¶Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">Lecturer (optional)</label><input id="courseLecturer" name="lecturer"/></div>
              </div>
              <div class="two-col">
                <div class="form-group"><label for="courseDescription" data-en="Course Description" data-ar="ÙˆØµÙ Ø§Ù„Ø¯ÙˆØ±Ø©">Course Description</label><input id="courseDescription" name="description" required/></div>
                <div class="form-group"><label for="courseLink" data-en="Link (optional)" data-ar="Ø§Ù„Ø±Ø§Ø¨Ø· (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">Link (optional)</label><input id="courseLink" name="link" type="url" placeholder="https://"/></div>
              </div>
              <div class="form-group">
                <label for="courseImageUrl" data-en="Image URL (Optional)" data-ar="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">Image URL (Optional)</label>
                <input type="url" id="courseImageUrl" name="imageUrl" placeholder="https://example.com/image.jpg"/>
              </div>
              <div class="form-group">
                <label for="courseEnrollUrl" data-en="Enroll Button URL (Optional)" data-ar="Ø±Ø§Ø¨Ø· Ø²Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">Enroll Button URL (Optional)</label>
                <input type="url" id="courseEnrollUrl" name="enrollUrl" placeholder="https://example.com/enroll"/>
              </div>
              <div id="courseErrors" class="error-box"></div>
              <button type="submit" id="courseSubmitBtn" class="submit-btn" data-en="Add Course" data-ar="Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ±Ø©">Add Course</button>
            </form>
          </div>
        </details>
      </section>

      <!-- FBD -->
      <section id="fbd-tab" class="tab-content">
        <details class="accordion" open>
          <summary data-en="FBD Page" data-ar="ØµÙØ­Ø© FBD">FBD Page</summary>
          <div class="accordion-body panel">
            <form id="fbdPageForm">
              <div class="two-col">
                <div class="form-group"><label for="fbdTitle" data-en="Page Title" data-ar="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø©">Page Title</label><input id="fbdTitle" name="pageTitle" placeholder="FBD"/></div>
                <div class="form-group"><label for="fbdAbout" data-en="About" data-ar="Ù†Ø¨Ø°Ø©">About</label><input id="fbdAbout" name="about" placeholder="About FBD..."/></div>
              </div>
              <button type="submit" class="submit-btn" data-en="Update FBD Page" data-ar="ØªØ­Ø¯ÙŠØ« ØµÙØ­Ø© FBD">Update FBD Page</button>
            </form>
          </div>
        </details>

        <details class="accordion" open>
          <summary data-en="FBD Events" data-ar="ÙØ¹Ø§Ù„ÙŠØ§Øª FBD">FBD Events</summary>
          <div class="accordion-body panel">
            <div class="panel" style="margin-bottom:.75rem">
              <h4 style="margin-top:0" data-en="Existing FBD Events" data-ar="ÙØ¹Ø§Ù„ÙŠØ§Øª FBD Ø§Ù„Ø­Ø§Ù„ÙŠØ©">Existing FBD Events</h4>
              <div id="existingFbdEventsList"><p>Loading FBD events...</p></div>
            </div>
            <form id="fbdEventForm" data-mode="add" novalidate>
              <input type="hidden" id="fbdEventId"/>
              <div class="two-col">
                <div class="form-group"><label for="fbdEventTitle" data-en="Event Title" data-ar="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ©">Event Title</label><input id="fbdEventTitle" name="title" required/></div>
                <div class="form-group"><label for="fbdEventTime" data-en="Date and Time" data-ar="Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª">Date and Time</label><input id="fbdEventTime" name="time" type="datetime-local" required/></div>
              </div>
              <div class="two-col">
                <div class="form-group"><label for="fbdEventLocation" data-en="Location" data-ar="Ø§Ù„Ù…ÙˆÙ‚Ø¹">Location</label><input id="fbdEventLocation" name="location" required/></div>
                <div class="form-group">
                  <label for="fbdEventType" data-en="Event Type" data-ar="Ù†ÙˆØ¹ Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ©">Event Type</label>
                  <select id="fbdEventType" name="type">
                    <!-- Options loaded dynamically from categories-loader -->
                  </select>
                </div>
              </div>
              <div class="two-col">
                <div class="form-group"><label for="fbdEventSeats" data-en="Available Seats" data-ar="Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø©">Available Seats</label><input id="fbdEventSeats" name="seats" type="number" min="1" value="10" required/></div>
                <div class="form-group"><label for="fbdEventImage" data-en="Emoji Icon" data-ar="Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ">Emoji Icon</label><input id="fbdEventImage" name="image" placeholder="ðŸŽ¨" required/></div>
              </div>
              <div class="form-group">
                <label for="fbdEventImageUrl" data-en="Image URL (Optional)" data-ar="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">Image URL (Optional)</label>
                <input type="url" id="fbdEventImageUrl" name="imageUrl" placeholder="https://example.com/image.jpg"/>
              </div>
              <div class="form-group">
                <label for="fbdEventRegisterUrl" data-en="Register Button URL (Optional)" data-ar="Ø±Ø§Ø¨Ø· Ø²Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">Register Button URL (Optional)</label>
                <input type="url" id="fbdEventRegisterUrl" name="registerUrl" placeholder="https://example.com/register"/>
              </div>
              <div class="form-group">
                <label for="fbdEventDetailsUrl" data-en="Details Button URL (Optional)" data-ar="Ø±Ø§Ø¨Ø· Ø²Ø± Ø§Ù„ØªÙØ§ØµÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">Details Button URL (Optional)</label>
                <input type="url" id="fbdEventDetailsUrl" name="detailsUrl" placeholder="https://example.com/details"/>
              </div>
              <div class="form-group">
                <label for="fbdEventGalleryUrl" data-en="Gallery Button URL (Optional)" data-ar="Ø±Ø§Ø¨Ø· Ø²Ø± Ø§Ù„Ù…Ø¹Ø±Ø¶ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">Gallery Button URL (Optional)</label>
                <input type="url" id="fbdEventGalleryUrl" name="galleryUrl" placeholder="https://example.com/gallery"/>
              </div>
              <div class="form-group"><label for="fbdEventDescription" data-en="Description" data-ar="Ø§Ù„ÙˆØµÙ">Description</label><textarea id="fbdEventDescription" name="description" required></textarea></div>
              <div id="fbdEventErrors" class="error-box"></div>
              <button type="submit" id="fbdEventSubmitBtn" class="submit-btn" data-en="Add FBD Event" data-ar="Ø¥Ø¶Ø§ÙØ© ÙØ¹Ø§Ù„ÙŠØ© FBD">Add FBD Event</button>
            </form>
          </div>
        </details>
      </section>

      <!-- Settings -->
      <section id="settings-tab" class="tab-content">
        <details class="accordion" open>
          <summary data-en="Connection" data-ar="Ø§Ù„Ø§ØªØµØ§Ù„">Connection</summary>
          <div class="accordion-body panel">
            <div id="tokenStatus" style="padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; background:#f8fafc;">
              <p><strong data-en="Status:" data-ar="Ø§Ù„Ø­Ø§Ù„Ø©:">Status:</strong> <span id="tokenStatusText">Checking...</span></p>
            </div>
            <p style="color:#4a5568;margin-bottom:1rem" data-en="Content is now stored in Firebase Firestore. No additional configuration needed." data-ar="ÙŠØªÙ… ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¢Ù† ÙÙŠ Firebase Firestore. Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„ØªÙƒÙˆÙŠÙ† Ø¥Ø¶Ø§ÙÙŠ.">Content is now stored in Firebase Firestore. No additional configuration needed.</p>
            <button type="button" class="submit-btn" onclick="testFirestoreConnection()" style="background:#38a169;" data-en="Test Connection" data-ar="Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„">Test Connection</button>
          </div>
        </details>

        <details class="accordion" open>
          <summary data-en="Firestore Structure" data-ar="Ø¨Ù†ÙŠØ© Firestore">Firestore Structure</summary>
          <div class="accordion-body panel">
            <div id="structureResults" style="display:none;padding:1rem;border-radius:8px;margin-bottom:1rem;max-height:300px;overflow-y:auto;background:#f8fafc;">
              <h4 data-en="Structure Validation Results:" data-ar="Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ù†ÙŠØ©:">Structure Validation Results:</h4>
              <div id="structureResultsContent"></div>
            </div>
            <button type="button" class="submit-btn" onclick="fixFirestoreStructure()" style="background:#667eea;" data-en="Fix Firestore Structure" data-ar="Ø¥ØµÙ„Ø§Ø­ Ø¨Ù†ÙŠØ© Firestore">Fix Firestore Structure</button>
          </div>
        </details>

        <details class="accordion" open>
          <summary data-en="Admin Management" data-ar="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†">Admin Management</summary>
          <div class="accordion-body panel">
            <div style="margin-bottom:1rem">
              <h4>Current Admins:</h4>
              <div id="adminsList" style="background:#f7fafc;padding:1rem;border-radius:8px;min-height:60px"><p>Loading...</p></div>
            </div>
            <div class="form-group">
          
              </div>
            </div>
          </div>
        </details>
      </section>
    </main>
  </div>

  <script type="module">
    /*************************************************
     * ØªÙ‡ÙŠØ¦Ø© Firebase Ùˆ FirestoreAPI
     *************************************************/
    import { initializeApp, getApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import FirestoreAPI from "./js/firestore-api.js";
    import categoriesLoader from "./js/categories-loader.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAyLFqSWDyLShllJIoqsr2Jjme47OJTPKQ",
      authDomain: "aias-bsr.firebaseapp.com",
      projectId: "aias-bsr",
      storageBucket: "aias-bsr.firebasestorage.app",
      messagingSenderId: "78055223814",
      appId: "1:78055223814:web:99460402c2b1fcd5ae8987",
      measurementId: "G-6W50T4HXDV"
    };

    let app;
    try { app = getApp(); } catch { app = initializeApp(firebaseConfig); }
    const auth = getAuth(app);
    const db = getFirestore(app);
    const firestoreAPI = new FirestoreAPI();

    let CACHE = { events: [], articles: [], library: [], courses: [], fbdEvents: [] };

    /*************************************************
     * ØªÙ†Ù‚Ù„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
     *************************************************/
    const mainNav = document.getElementById('mainNav');
    mainNav.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-tab]');
      if (!btn) return;
      const tab = btn.getAttribute('data-tab');
      document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      showTab(tab);
    });

    document.getElementById('expandAll').addEventListener('click', () => {
      document.querySelectorAll('.tab-content.active details.accordion').forEach(d => d.open = true);
    });
    document.getElementById('collapseAll').addEventListener('click', () => {
      document.querySelectorAll('.tab-content.active details.accordion').forEach(d => d.open = false);
    });

    /*************************************************
     * ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
     *************************************************/
    window.logout = async function() {
      try {
        await signOut(auth);
        ['aias_authenticated','aias_user_email','aias_user_name','aias_user_picture','aias_is_admin','aias_user_uid']
          .forEach(localStorage.removeItem.bind(localStorage));
        window.location.href = 'login.html';
      } catch (error) {
        console.error('Logout error:', error);
        alert('Error signing out. Please try again.');
      }
    };

    async function checkIfAdmin(email) {
      try {
        const adminDoc = await getDoc(doc(db, 'config', 'admins'));
        if (adminDoc.exists()) {
          const data = adminDoc.data();
            return Array.isArray(data.admins) && data.admins.includes(email.toLowerCase());
        }
      } catch (error) { console.error('Error checking admin status:', error); }
      return false;
    }

    (function() {
      onAuthStateChanged(auth, async (user) => {
        if (!user) { window.location.href = 'login.html'; return; }
        const isAdmin = await checkIfAdmin(user.email);
        if (!isAdmin) { alert('Access denied. Admin privileges required.'); window.location.href = 'login.html'; return; }
        localStorage.setItem('aias_authenticated','true');
        localStorage.setItem('aias_user_email', user.email);
        localStorage.setItem('aias_user_name', user.displayName || 'Admin');
        localStorage.setItem('aias_user_picture', user.photoURL || '');
        localStorage.setItem('aias_is_admin','true');
        localStorage.setItem('aias_user_uid', user.uid);
        document.getElementById('currentLang').textContent = (localStorage.getItem('language') || 'EN').toUpperCase();
        
        // Populate category dropdowns from JSON
        await populateCategoryDropdowns();
        
        // Add language toggle event listener to re-populate categories
        const langToggle = document.getElementById('languageToggle');
        if (langToggle) {
          langToggle.addEventListener('click', async () => {
            // Wait a bit for main.js to update the language
            setTimeout(async () => {
              await populateCategoryDropdowns();
            }, 100);
          });
        }
        
        showTab('events'); // default
      });
    })();

    /*************************************************
     * ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ¦Ø§Øª Ù…Ù† JSON
     *************************************************/
    async function populateCategoryDropdowns() {
      try {
        console.log('[Admin Dashboard] Loading categories from JSON...');
        
        // Get current language
        const currentLang = localStorage.getItem('language') || 'en';
        
        // Load event types
        const eventTypes = await categoriesLoader.getEventTypes();
        const eventTypeSelect = document.getElementById('eventType');
        const fbdEventTypeSelect = document.getElementById('fbdEventType');
        
        if (eventTypeSelect) {
          const currentValue = eventTypeSelect.value;
          eventTypeSelect.innerHTML = eventTypes.map(type => {
            // Handle both old format (string) and new format (object with en/ar)
            const value = typeof type === 'string' ? type : type.en;
            const label = typeof type === 'string' ? type : (currentLang === 'ar' ? type.ar : type.en);
            return `<option value="${value}">${label}</option>`;
          }).join('');
          if (currentValue) eventTypeSelect.value = currentValue;
        }
        
        if (fbdEventTypeSelect) {
          const currentValue = fbdEventTypeSelect.value;
          fbdEventTypeSelect.innerHTML = eventTypes.map(type => {
            const value = typeof type === 'string' ? type : type.en;
            const label = typeof type === 'string' ? type : (currentLang === 'ar' ? type.ar : type.en);
            return `<option value="${value}">${label}</option>`;
          }).join('');
          if (currentValue) fbdEventTypeSelect.value = currentValue;
        }
        
        // Load library categories (basic)
        const libraryCategories = await categoriesLoader.getLibraryCategoriesBasic();
        const libCategorySelect = document.getElementById('libCategory');
        
        if (libCategorySelect) {
          const currentValue = libCategorySelect.value;
          libCategorySelect.innerHTML = libraryCategories.map(cat => {
            // Handle both old format and new format with translations
            const value = cat.value;
            const label = typeof cat.label === 'string' 
              ? cat.label 
              : (currentLang === 'ar' ? cat.label.ar : cat.label.en);
            return `<option value="${value}">${label}</option>`;
          }).join('');
          if (currentValue) libCategorySelect.value = currentValue;
        }
        
        console.log('[Admin Dashboard] âœ“ Categories loaded successfully');
      } catch (error) {
        console.error('[Admin Dashboard] âœ— Error loading categories:', error);
      }
    }

    /*************************************************
     * Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ø¬Ù‡Ø©
     *************************************************/
    function showMessage(text, type) {
      const el = document.getElementById('message');
      el.textContent = text;
      el.className = `message ${type}`;
      el.style.display = 'block';
      setTimeout(()=>{el.style.display='none'}, 5000);
    }
    window.showMessage = showMessage;

    window.reapplyTranslations = function() {
      if (typeof setLanguage === 'function') {
        const lang = localStorage.getItem('language') || 'en';
        setLanguage(lang);
      }
    };

    window.showTab = function(tab) {
      document.querySelectorAll('.content > .tab-content').forEach(t=>t.classList.remove('active'));
      const target = document.getElementById(`${tab}-tab`);
      if (target) target.classList.add('active');
      if (tab==='events') loadExistingEvents();
      if (tab==='articles') loadExistingArticles();
      if (tab==='library') loadExistingLibraryResources();
      if (tab==='education') { loadEducationContent(); loadCourses(); }
      if (tab==='fbd') { loadFbd(); }
      if (tab==='settings') { testFirestoreConnection(); loadAdminsList?.(); }
    };

    /*************************************************
     * ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
     *************************************************/
    window.loadExistingEvents = async function() {
      const box = document.getElementById('existingEventsList');
      box.innerHTML = '<p>Loading events...</p>';
      try {
        const r = await firestoreAPI.getAllContent();
        if (!r.success) throw new Error(r.error);
        CACHE.events = r.content.events || [];
        if (CACHE.events.length===0) { box.innerHTML = '<p>No events found.</p>'; return; }
        box.innerHTML = CACHE.events.map(ev => `
          <div class="content-item">
            <div><strong>${ev.title || '(no title)'}</strong><br><small>${ev.time ? new Date(ev.time).toLocaleString() : 'â€”'} ${ev.location ? ' - ' + ev.location : ''}</small></div>
            <div class="user-actions">
              <button class="btn edit-btn" onclick="editEvent('${ev.id}')">Edit</button>
              <button class="btn delete-btn" onclick="deleteEvent('${ev.id}')">Delete</button>
            </div>
          </div>
        `).join('');
        reapplyTranslations();
      } catch (e) { console.error(e); box.innerHTML='<p style="color:red">Error loading events</p>'; }
    };

    window.editEvent = function(id) {
      const ev = CACHE.events.find(x=>x.id===id); if (!ev) return;
      eventForm.dataset.mode = 'edit';
      eventId.value = ev.id;
      eventTitle.value = ev.title || '';
      eventTime.value = ev.time ? new Date(ev.time).toISOString().slice(0,16) : '';
      eventLocation.value = ev.location || '';
      eventType.value = ev.type || 'Workshop';
      eventSeats.value = ev.seats ?? 10;
      eventImage.value = ev.image || '';
      eventImageUrl.value = ev.imageUrl || '';
      eventRegisterUrl.value = ev.registerUrl || '';
      eventDetailsUrl.value = ev.detailsUrl || '';
      eventGalleryUrl.value = ev.galleryUrl || '';
      eventDescription.value = ev.description || '';
      eventSubmitBtn.textContent = 'Update Event';
    };

    window.deleteEvent = async function(id) {
      if (!confirm('Are you sure you want to delete this event?')) return;
      const r = await firestoreAPI.deleteEvent(id);
      if (r.success) { showMessage('Event deleted successfully!', 'success'); loadExistingEvents(); }
      else showMessage(r.error || 'Failed to delete event', 'error');
    };

    window.loadExistingArticles = async function() {
      const box = document.getElementById('existingArticlesList');
      box.innerHTML = '<p>Loading articles...</p>';
      try {
        const r = await firestoreAPI.getAllContent();
        if (!r.success) throw new Error(r.error);
        CACHE.articles = r.content.magazine?.articles || [];
        if (CACHE.articles.length===0) { box.innerHTML = '<p>No articles found.</p>'; return; }
        box.innerHTML = CACHE.articles.map(a => `
          <div class="content-item">
            <div><strong>${a.title || '(no title)'}</strong><br><small>${a.author ? 'by ' + a.author : ''} ${a.date || ''}</small></div>
            <div class="user-actions">
              <button class="btn edit-btn" onclick="editArticle('${a.id}')">Edit</button>
              <button class="btn delete-btn" onclick="deleteArticle('${a.id}')">Delete</button>
            </div>
          </div>
        `).join('');
        reapplyTranslations();
      } catch (e) { console.error(e); box.innerHTML='<p style="color:red">Error loading articles</p>'; }
    };

    window.editArticle = function(id) {
      const a = CACHE.articles.find(x=>x.id===id); if (!a) return;
      articleForm.dataset.mode = 'edit';
      articleId.value = a.id;
      articleTitle.value = a.title || '';
      articleAuthor.value = a.author || '';
      articleDate.value = a.date || '';
      articleSummary.value = a.summary || '';
      articleContent.value = a.content || '';
      articleImageUrl.value = a.imageUrl || '';
      articleReadMoreUrl.value = a.readMoreUrl || '';
      articleSubmitBtn.textContent = 'Update Article';
    };

    window.deleteArticle = async function(id) {
      if (!confirm('Are you sure you want to delete this article?')) return;
      const r = await firestoreAPI.deleteArticle(id);
      if (r.success) { showMessage('Article deleted successfully!', 'success'); loadExistingArticles(); }
      else showMessage(r.error || 'Failed to delete article', 'error');
    };

    window.loadExistingLibraryResources = async function() {
      const box = document.getElementById('existingLibraryList');
      box.innerHTML = '<p>Loading resources...</p>';
      try {
        const r = await firestoreAPI.getAllContent();
        if (!r.success) throw new Error(r.error);
        CACHE.library = r.content.library || [];
        if (CACHE.library.length===0) { box.innerHTML = '<p>No resources found.</p>'; return; }
        box.innerHTML = CACHE.library.map(it => `
          <div class="content-item">
            <div><strong>${it.name || '(no name)'}</strong><br><small>${it.type || ''} - ${it.category || 'file'}${Array.isArray(it.tags) && it.tags.length ? ' - ' + it.tags.join(', ') : ''}</small></div>
            <div class="user-actions">
              <button class="btn edit-btn" onclick="editLibrary('${it.id}')">Edit</button>
              <button class="btn delete-btn" onclick="deleteLibraryResource('${it.id}')">Delete</button>
            </div>
          </div>
        `).join('');
        reapplyTranslations();
      } catch (e) { console.error(e); box.innerHTML='<p style="color:red">Error loading resources</p>'; }
    };

    window.editLibrary = function(id) {
      const r = CACHE.library.find(x=>x.id===id); if (!r) return;
      libraryForm.dataset.mode = 'edit';
      libId.value = r.id;
      libName.value = r.name || '';
      libType.value = r.type || 'Book';
      libCategory.value = r.category || 'file';
      libTags.value = Array.isArray(r.tags) ? r.tags.join(', ') : (r.tags || '');
      libImage.value = r.image || '';
      libImageUrl.value = r.imageUrl || '';
      libDescription.value = r.description || '';
      libLink.value = r.link || '';
      libSubmitBtn.textContent = 'Update Resource';
    };

    window.deleteLibraryResource = async function(id) {
      if (!confirm('Are you sure you want to delete this resource?')) return;
      const r = await firestoreAPI.deleteLibraryResource(id);
      if (r.success) { showMessage('Resource deleted successfully!', 'success'); loadExistingLibraryResources(); }
      else showMessage(r.error || 'Failed to delete resource', 'error');
    };

    window.loadEducationContent = async function() {
      try {
        const r = await firestoreAPI.getAllContent();
        const w = r.success ? r.content.education?.weeklyWorkshop : null;
        if (w) { 
          weekTitle.value = w.weekTitle || ''; 
          lecturerName.value = w.lecturerName || ''; 
          weekDescription.value = w.description || ''; 
          workshopUrl.value = w.workshopUrl || '';
        }
      } catch (e) { console.error(e); }
    };

    window.loadCourses = async function() {
      const box = document.getElementById('existingCoursesList');
      box.innerHTML = '<p>Loading courses...</p>';
      try {
        const r = await firestoreAPI.getAllContent();
        if (!r.success) throw new Error(r.error);
        CACHE.courses = r.content.education?.courses || [];
        if (CACHE.courses.length===0) { box.innerHTML = '<p>No courses found.</p>'; return; }
        box.innerHTML = CACHE.courses.map(c => `
          <div class="content-item">
            <div><strong>${c.title || '(no title)'}</strong><br><small>${c.lecturer ? c.lecturer+' â€” ' : ''}${c.link ? `<a href="${c.link}" target="_blank" rel="noopener noreferrer">Link</a>` : ''}</small></div>
            <div class="user-actions">
              <button class="btn edit-btn" onclick="editCourse('${c.id}')">Edit</button>
              <button class="btn delete-btn" onclick="deleteCourse('${c.id}')">Delete</button>
            </div>
          </div>
        `).join('');
      } catch (e) { console.error(e); box.innerHTML = '<p style="color:red">Error loading courses</p>'; }
    };

    window.editCourse = function(id) {
      const c = CACHE.courses.find(x=>x.id===id); if (!c) return;
      courseForm.dataset.mode = 'edit';
      courseId.value = c.id;
      courseTitle.value = c.title || '';
      courseDescription.value = c.description || '';
      courseLecturer.value = c.lecturer || '';
      courseLink.value = c.link || '';
      courseImageUrl.value = c.imageUrl || '';
      courseEnrollUrl.value = c.enrollUrl || '';
      courseSubmitBtn.textContent = 'Update Course';
    };

    window.deleteCourse = async function(id) {
      if (!confirm('Are you sure you want to delete this course?')) return;
      const r = await firestoreAPI.deleteCourse(id);
      if (r.success) { showMessage('Course deleted', 'success'); loadCourses(); }
      else showMessage(r.error || 'Failed to delete course', 'error');
    };

    window.loadFbd = async function() {
      const box = document.getElementById('existingFbdEventsList');
      box.innerHTML = '<p>Loading FBD events...</p>';
      try {
        const r = await firestoreAPI.getAllContent();
        if (!r.success) throw new Error(r.error);
        const fbd = r.content.education?.fbd || { pageTitle:'', about:'', events:[] };
        fbdTitle.value = fbd.pageTitle || '';
        fbdAbout.value = fbd.about || '';
        CACHE.fbdEvents = fbd.events || [];
        if (CACHE.fbdEvents.length===0) { box.innerHTML = '<p>No FBD events found.</p>'; return; }
        box.innerHTML = CACHE.fbdEvents.map(ev => `
          <div class="content-item">
            <div><strong>${ev.title || '(no title)'}</strong><br><small>${ev.time ? new Date(ev.time).toLocaleString() : 'â€”'} ${ev.location ? ' - ' + ev.location : ''}</small></div>
            <div class="user-actions">
              <button class="btn edit-btn" onclick="editFbdEvent('${ev.id}')">Edit</button>
              <button class="btn delete-btn" onclick="deleteFbdEvent('${ev.id}')">Delete</button>
            </div>
          </div>
        `).join('');
      } catch (e) { console.error(e); box.innerHTML = '<p style="color:red">Error loading FBD</p>'; }
    };

    window.editFbdEvent = function(id) {
      const ev = CACHE.fbdEvents.find(x=>x.id===id); if (!ev) return;
      fbdEventForm.dataset.mode = 'edit';
      fbdEventId.value = ev.id;
      fbdEventTitle.value = ev.title || '';
      fbdEventTime.value = ev.time ? new Date(ev.time).toISOString().slice(0,16) : '';
      fbdEventLocation.value = ev.location || '';
      fbdEventType.value = ev.type || 'Workshop';
      fbdEventSeats.value = ev.seats ?? 10;
      fbdEventImage.value = ev.image || '';
      fbdEventImageUrl.value = ev.imageUrl || '';
      fbdEventRegisterUrl.value = ev.registerUrl || '';
      fbdEventDetailsUrl.value = ev.detailsUrl || '';
      fbdEventGalleryUrl.value = ev.galleryUrl || '';
      fbdEventDescription.value = ev.description || '';
      fbdEventSubmitBtn.textContent = 'Update FBD Event';
    };

    window.deleteFbdEvent = async function(id) {
      if (!confirm('Are you sure you want to delete this FBD event?')) return;
      const r = await firestoreAPI.deleteFbdEvent(id);
      if (r.success) { showMessage('FBD event deleted', 'success'); loadFbd(); }
      else showMessage(r.error || 'Failed to delete FBD event', 'error');
    };

    /*************************************************
     * Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
     *************************************************/
    const eventForm         = document.getElementById('eventForm');
    const eventId           = document.getElementById('eventId');
    const eventTitle        = document.getElementById('eventTitle');
    const eventTime         = document.getElementById('eventTime');
    const eventLocation     = document.getElementById('eventLocation');
    const eventType         = document.getElementById('eventType');
    const eventSeats        = document.getElementById('eventSeats');
    const eventImage        = document.getElementById('eventImage');
    const eventImageUrl     = document.getElementById('eventImageUrl');
    const eventRegisterUrl  = document.getElementById('eventRegisterUrl');
    const eventDetailsUrl   = document.getElementById('eventDetailsUrl');
    const eventGalleryUrl   = document.getElementById('eventGalleryUrl');
    const eventDescription  = document.getElementById('eventDescription');
    const eventSubmitBtn    = document.getElementById('eventSubmitBtn');
    const eventErrorsBox    = document.getElementById('eventErrors');

    const articleForm       = document.getElementById('articleForm');
    const articleId         = document.getElementById('articleId');
    const articleTitle      = document.getElementById('articleTitle');
    const articleAuthor     = document.getElementById('articleAuthor');
    const articleDate       = document.getElementById('articleDate');
    const articleSummary    = document.getElementById('articleSummary');
    const articleContent    = document.getElementById('articleContent');
    const articleImageUrl   = document.getElementById('articleImageUrl');
    const articleReadMoreUrl = document.getElementById('articleReadMoreUrl');
    const articleSubmitBtn  = document.getElementById('articleSubmitBtn');
    const articleErrorsBox  = document.getElementById('articleErrors');

    const libraryForm       = document.getElementById('libraryForm');
    const libId             = document.getElementById('libId');
    const libName           = document.getElementById('libName');
    const libType           = document.getElementById('libType');
    const libCategory       = document.getElementById('libCategory');
    const libTags           = document.getElementById('libTags');
    const libImage          = document.getElementById('libImage');
    const libImageUrl       = document.getElementById('libImageUrl');
    const libDescription    = document.getElementById('libDescription');
    const libLink           = document.getElementById('libLink');
    const libSubmitBtn      = document.getElementById('libSubmitBtn');
    const libraryErrorsBox  = document.getElementById('libraryErrors');

    const educationForm     = document.getElementById('educationForm');
    const weekTitle         = document.getElementById('weekTitle');
    const lecturerName      = document.getElementById('lecturerName');
    const weekDescription   = document.getElementById('weekDescription');
    const workshopUrl       = document.getElementById('workshopUrl');
    const educationErrorsBox= document.getElementById('educationErrors');

    const courseForm        = document.getElementById('courseForm');
    const courseId          = document.getElementById('courseId');
    const courseTitle       = document.getElementById('courseTitle');
    const courseDescription = document.getElementById('courseDescription');
    const courseLecturer    = document.getElementById('courseLecturer');
    const courseLink        = document.getElementById('courseLink');
    const courseImageUrl    = document.getElementById('courseImageUrl');
    const courseEnrollUrl   = document.getElementById('courseEnrollUrl');
    const courseSubmitBtn   = document.getElementById('courseSubmitBtn');
    const courseErrorsBox   = document.getElementById('courseErrors');

    const fbdPageForm       = document.getElementById('fbdPageForm');
    const fbdTitle          = document.getElementById('fbdTitle');
    const fbdAbout          = document.getElementById('fbdAbout');

    const fbdEventForm          = document.getElementById('fbdEventForm');
    const fbdEventId            = document.getElementById('fbdEventId');
    const fbdEventTitle         = document.getElementById('fbdEventTitle');
    const fbdEventTime          = document.getElementById('fbdEventTime');
    const fbdEventLocation      = document.getElementById('fbdEventLocation');
    const fbdEventType          = document.getElementById('fbdEventType');
    const fbdEventSeats         = document.getElementById('fbdEventSeats');
    const fbdEventImage         = document.getElementById('fbdEventImage');
    const fbdEventImageUrl      = document.getElementById('fbdEventImageUrl');
    const fbdEventRegisterUrl   = document.getElementById('fbdEventRegisterUrl');
    const fbdEventDetailsUrl    = document.getElementById('fbdEventDetailsUrl');
    const fbdEventGalleryUrl    = document.getElementById('fbdEventGalleryUrl');
    const fbdEventDescription   = document.getElementById('fbdEventDescription');
    const fbdEventSubmitBtn     = document.getElementById('fbdEventSubmitBtn');
    const fbdEventErrorsBox     = document.getElementById('fbdEventErrors');

    /*************************************************
     * Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØªØ­Ù‚Ù‚
     *************************************************/
    function showErrors(box, errors) {
      if (!box) return;
      if (!errors.length) {
        box.style.display = 'none';
        box.innerHTML = '';
        return;
      }
      box.style.display = 'block';
      box.innerHTML = `<ul>${errors.map(e=>`<li>${e}</li>`).join('')}</ul>`;
    }

    function toISO(dtValue) {
      if (!dtValue) return '';
      const date = new Date(dtValue);
      return isNaN(date.getTime()) ? '' : date.toISOString();
    }

    function validateEventPayload(p) {
      const errors = [];
      // p already contains trimmed values from submit handler
      if (!p.title || p.title.length < 3) errors.push('Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ø·Ù„ÙˆØ¨ (3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„).');
      if (!p.time) errors.push('Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª Ù…Ø·Ù„ÙˆØ¨Ø§Ù†.');
      if (!p.location || p.location.length < 2) errors.push('Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ø·Ù„ÙˆØ¨.');
      if (!p.description || p.description.length < 10) errors.push('Ø§Ù„ÙˆØµÙ Ù…Ø·Ù„ÙˆØ¨ (10 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„).');
      if (!Number.isFinite(p.seats) || p.seats <= 0) errors.push('Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø±Ù‚Ù…Ù‹Ø§ Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±.');
      if (!p.image || p.image.length === 0) errors.push('Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ù…Ø·Ù„ÙˆØ¨ (Ø§ÙƒØªØ¨Ù‡ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ù‚Ù„).');
      return errors;
    }

    function validateFbdEventPayload(p) {
      // Ù†ÙØ³ Ù…Ù†Ø·Ù‚ Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
      return validateEventPayload(p);
    }

    function validateArticlePayload(p) {
      const errors = [];
      // p already contains trimmed values from submit handler
      if (!p.title || p.title.length === 0) errors.push('Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‚Ø§Ù„ Ù…Ø·Ù„ÙˆØ¨.');
      if (!p.author || p.author.length === 0) errors.push('Ø§Ø³Ù… Ø§Ù„ÙƒØ§ØªØ¨ Ù…Ø·Ù„ÙˆØ¨.');
      if (!p.date || p.date.length === 0) errors.push('Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ø·Ù„ÙˆØ¨.');
      if (!p.summary || p.summary.length < 5) errors.push('Ø§Ù„Ù…Ù„Ø®Øµ Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹.');
      if (!p.content || p.content.length < 20) errors.push('Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 20 Ø­Ø±ÙØ§Ù‹ ÙØ£ÙƒØ«Ø±.');
      return errors;
    }

    function validateLibraryPayload(p) {
      const errors = [];
      // p already contains trimmed values from submit handler
      if (!p.name || p.name.length === 0) errors.push('Ø§Ø³Ù… Ø§Ù„Ù…ØµØ¯Ø± Ù…Ø·Ù„ÙˆØ¨.');
      if (!p.type || p.type.length === 0) errors.push('Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ¯Ø± Ù…Ø·Ù„ÙˆØ¨.');
      if (!p.description || p.description.length < 5) errors.push('Ø§Ù„ÙˆØµÙ Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹.');
      if (!p.image || p.image.length === 0) errors.push('Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ù…Ø·Ù„ÙˆØ¨.');
      if (!p.link || p.link.length === 0) errors.push('Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø·Ù„ÙˆØ¨.');
      return errors;
    }

    function validateCoursePayload(p) {
      const errors = [];
      // p already contains trimmed values from submit handler
      if (!p.title || p.title.length === 0) errors.push('Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯ÙˆØ±Ø© Ù…Ø·Ù„ÙˆØ¨.');
      if (!p.description || p.description.length < 5) errors.push('ÙˆØµÙ Ø§Ù„Ø¯ÙˆØ±Ø© Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹.');
      return errors;
    }

    function validateWorkshopPayload(p) {
      const errors = [];
      // p already contains trimmed values from submit handler
      if (!p.weekTitle || p.weekTitle.length === 0) errors.push('Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ±Ø´Ø© Ù…Ø·Ù„ÙˆØ¨.');
      if (!p.lecturerName || p.lecturerName.length === 0) errors.push('Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø§Ø¶Ø± Ù…Ø·Ù„ÙˆØ¨.');
      if (!p.description || p.description.length < 10) errors.push('Ø§Ù„ÙˆØµÙ Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹.');
      return errors;
    }

    /*************************************************
     * Ø¥Ø±Ø³Ø§Ù„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ© (Events)
     *************************************************/
    eventForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      
      const mode = eventForm.dataset.mode || 'add';
      
      // Debug: Direct read before building payload
      console.log('[DEBUG DIRECT READ]', {
        title: eventTitle.value,
        timeRaw: eventTime.value,
        location: eventLocation.value,
        type: eventType.value,
        seats: eventSeats.value,
        image: eventImage.value,
        imageUrl: eventImageUrl.value,
        registerUrl: eventRegisterUrl.value,
        detailsUrl: eventDetailsUrl.value,
        galleryUrl: eventGalleryUrl.value,
        description: eventDescription.value
      });
      
      const payload = {
        title: eventTitle.value.trim(),
        time: toISO(eventTime.value),
        location: eventLocation.value.trim(),
        type: eventType.value,
        seats: Number(eventSeats.value),
        image: eventImage.value.trim(),
        imageUrl: eventImageUrl.value.trim(),
        registerUrl: eventRegisterUrl.value.trim(),
        detailsUrl: eventDetailsUrl.value.trim(),
        galleryUrl: eventGalleryUrl.value.trim(),
        description: eventDescription.value.trim()
      };
      console.log('[EventForm] Raw values:', payload);
      const errors = validateEventPayload(payload);
      showErrors(eventErrorsBox, errors);
      if (errors.length) { console.warn('[EventForm] Validation failed:', errors); return; }

      eventSubmitBtn.disabled = true;
      const originalText = eventSubmitBtn.textContent;
      eventSubmitBtn.textContent = mode === 'edit' ? 'Updating...' : 'Saving...';

      try {
        const r = mode==='edit'
          ? await firestoreAPI.updateEvent(eventId.value, payload)
          : await firestoreAPI.addEvent(payload);
        if (r.success) {
          showMessage('Event saved successfully!', 'success');
          eventForm.reset();
          eventForm.dataset.mode = 'add';
          eventSubmitBtn.textContent = 'Add Event';
          loadExistingEvents();
        } else {
          showMessage(r.error || 'Failed to save event', 'error');
        }
      } catch (err) {
        console.error('[EventForm] Exception:', err);
        showMessage('Unexpected error saving event', 'error');
      } finally {
        eventSubmitBtn.disabled = false;
        if (mode !== 'edit') eventSubmitBtn.textContent = originalText;
      }
    }, true);

    /*************************************************
     * Ø¥Ø±Ø³Ø§Ù„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ù‚Ø§Ù„ (Articles)
     *************************************************/
    articleForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      
      const mode = articleForm.dataset.mode || 'add';
      const payload = {
        title: articleTitle.value.trim(),
        author: articleAuthor.value.trim(),
        date: articleDate.value,
        summary: articleSummary.value.trim(),
        content: articleContent.value.trim(),
        imageUrl: articleImageUrl.value.trim(),
        readMoreUrl: articleReadMoreUrl.value.trim()
      };
      const errors = validateArticlePayload(payload);
      showErrors(articleErrorsBox, errors);
      if (errors.length) { console.warn('[ArticleForm] Validation failed:', errors); return; }

      articleSubmitBtn.disabled = true;
      const originalText = articleSubmitBtn.textContent;
      articleSubmitBtn.textContent = mode === 'edit' ? 'Updating...' : 'Saving...';

      try {
        const r = mode==='edit'
          ? await firestoreAPI.updateArticle(articleId.value, payload)
          : await firestoreAPI.addArticle(payload);
        if (r.success) {
          showMessage('Article saved successfully!', 'success');
          articleForm.reset();
          articleForm.dataset.mode = 'add';
          articleSubmitBtn.textContent = 'Add Article';
          loadExistingArticles();
        } else {
          showMessage(r.error || 'Failed to save article', 'error');
        }
      } catch (err) {
        console.error('[ArticleForm] Exception:', err);
        showMessage('Unexpected error saving article', 'error');
      } finally {
        articleSubmitBtn.disabled = false;
        if (mode !== 'edit') articleSubmitBtn.textContent = originalText;
      }
    }, true);

    /*************************************************
     * Ø¥Ø±Ø³Ø§Ù„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…ÙƒØªØ¨Ø© (Library)
     *************************************************/
    libraryForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      
      const mode = libraryForm.dataset.mode || 'add';
      const payload = {
        name: libName.value.trim(),
        type: libType.value,
        category: libCategory.value,
        tags: libTags.value ? libTags.value.split(',').map(t=>t.trim()).filter(Boolean) : [],
        image: libImage.value.trim(),
        imageUrl: libImageUrl.value.trim(),
        description: libDescription.value.trim(),
        link: libLink.value.trim()
      };
      const errors = validateLibraryPayload(payload);
      showErrors(libraryErrorsBox, errors);
      if (errors.length) { console.warn('[LibraryForm] Validation failed:', errors); return; }

      libSubmitBtn.disabled = true;
      const originalText = libSubmitBtn.textContent;
      libSubmitBtn.textContent = mode === 'edit' ? 'Updating...' : 'Saving...';

      try {
        const r = mode==='edit'
          ? await firestoreAPI.updateLibraryResource(libId.value, payload)
          : await firestoreAPI.addLibraryResource(payload);
        if (r.success) {
          showMessage('Resource saved successfully!', 'success');
          libraryForm.reset();
          libraryForm.dataset.mode = 'add';
          libSubmitBtn.textContent = 'Add Resource';
          loadExistingLibraryResources();
        } else {
          showMessage(r.error || 'Failed to save resource', 'error');
        }
      } catch (err) {
        console.error('[LibraryForm] Exception:', err);
        showMessage('Unexpected error saving resource', 'error');
      } finally {
        libSubmitBtn.disabled = false;
        if (mode !== 'edit') libSubmitBtn.textContent = originalText;
      }
    }, true);

    /*************************************************
     * Ø¥Ø±Ø³Ø§Ù„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ÙˆØ±Ø´Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© (Education)
     *************************************************/
    educationForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      
      const payload = {
        weekTitle: weekTitle.value.trim(),
        lecturerName: lecturerName.value.trim(),
        description: weekDescription.value.trim(),
        workshopUrl: workshopUrl.value.trim()
      };
      const errors = validateWorkshopPayload(payload);
      showErrors(educationErrorsBox, errors);
      if (errors.length) { console.warn('[EducationForm] Validation failed:', errors); return; }

      try {
        const r = await firestoreAPI.updateEducation(payload);
        if (r.success) showMessage('Education content updated!', 'success');
        else showMessage(r.error || 'Failed to update education content', 'error');
      } catch (err) {
        console.error('[EducationForm] Exception:', err);
        showMessage('Unexpected error updating education content', 'error');
      }
    }, true);

    /*************************************************
     * Ø¥Ø±Ø³Ø§Ù„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¯ÙˆØ±Ø§Øª (Courses)
     *************************************************/
    courseForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      
      const mode = courseForm.dataset.mode || 'add';
      const payload = {
        title: courseTitle.value.trim(),
        description: courseDescription.value.trim(),
        lecturer: courseLecturer.value.trim(),
        link: courseLink.value.trim(),
        imageUrl: courseImageUrl.value.trim(),
        enrollUrl: courseEnrollUrl.value.trim()
      };
      const errors = validateCoursePayload(payload);
      showErrors(courseErrorsBox, errors);
      if (errors.length) { console.warn('[CourseForm] Validation failed:', errors); return; }

      courseSubmitBtn.disabled = true;
      const originalText = courseSubmitBtn.textContent;
      courseSubmitBtn.textContent = mode === 'edit' ? 'Updating...' : 'Saving...';

      try {
        const r = mode==='edit'
          ? await firestoreAPI.updateCourse(courseId.value, payload)
          : await firestoreAPI.addCourse(payload);
        if (r.success) {
          showMessage('Course saved', 'success');
          courseForm.reset();
          courseForm.dataset.mode = 'add';
          courseSubmitBtn.textContent = 'Add Course';
          loadCourses();
        } else {
          showMessage(r.error || 'Failed to save course', 'error');
        }
      } catch (err) {
        console.error('[CourseForm] Exception:', err);
        showMessage('Unexpected error saving course', 'error');
      } finally {
        courseSubmitBtn.disabled = false;
        if (mode !== 'edit') courseSubmitBtn.textContent = originalText;
      }
    }, true);

    /*************************************************
     * Ø¥Ø±Ø³Ø§Ù„ Ù†Ù…ÙˆØ°Ø¬ ØµÙØ­Ø© FBD
     *************************************************/
    fbdPageForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const r = await firestoreAPI.updateFbdPage({
          pageTitle: fbdTitle.value,
          about: fbdAbout.value
        });
        if (r.success) showMessage('FBD page updated', 'success');
        else showMessage(r.error || 'Failed to update FBD page', 'error');
      } catch (err) {
        console.error('[FbdPageForm] Exception:', err);
        showMessage('Unexpected error updating FBD page', 'error');
      }
    });

    /*************************************************
     * Ø¥Ø±Ø³Ø§Ù„ Ù†Ù…ÙˆØ°Ø¬ ÙØ¹Ø§Ù„ÙŠØ© FBD (FBD Events)
     *************************************************/
    fbdEventForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      
      const mode = fbdEventForm.dataset.mode || 'add';
      
      // Debug: Direct read before building payload
      console.log('[DEBUG DIRECT READ - FBD]', {
        title: fbdEventTitle.value,
        timeRaw: fbdEventTime.value,
        location: fbdEventLocation.value,
        type: fbdEventType.value,
        seats: fbdEventSeats.value,
        image: fbdEventImage.value,
        imageUrl: fbdEventImageUrl.value,
        registerUrl: fbdEventRegisterUrl.value,
        detailsUrl: fbdEventDetailsUrl.value,
        galleryUrl: fbdEventGalleryUrl.value,
        description: fbdEventDescription.value
      });
      
      const payload = {
        title: fbdEventTitle.value.trim(),
        time: toISO(fbdEventTime.value),
        location: fbdEventLocation.value.trim(),
        type: fbdEventType.value,
        seats: Number(fbdEventSeats.value),
        image: fbdEventImage.value.trim(),
        imageUrl: fbdEventImageUrl.value.trim(),
        registerUrl: fbdEventRegisterUrl.value.trim(),
        detailsUrl: fbdEventDetailsUrl.value.trim(),
        galleryUrl: fbdEventGalleryUrl.value.trim(),
        description: fbdEventDescription.value.trim()
      };
      const errors = validateFbdEventPayload(payload);
      showErrors(fbdEventErrorsBox, errors);
      if (errors.length) { console.warn('[FbdEventForm] Validation failed:', errors); return; }

      fbdEventSubmitBtn.disabled = true;
      const originalText = fbdEventSubmitBtn.textContent;
      fbdEventSubmitBtn.textContent = mode === 'edit' ? 'Updating...' : 'Saving...';

      try {
        const r = mode==='edit'
          ? await firestoreAPI.updateFbdEvent(fbdEventId.value, payload)
          : await firestoreAPI.addFbdEvent(payload);
        if (r.success) {
          showMessage('FBD event saved', 'success');
          fbdEventForm.reset();
          fbdEventForm.dataset.mode = 'add';
          fbdEventSubmitBtn.textContent = 'Add FBD Event';
          loadFbd();
        } else {
          showMessage(r.error || 'Failed to save FBD event', 'error');
        }
      } catch (err) {
        console.error('[FbdEventForm] Exception:', err);
        showMessage('Unexpected error saving FBD event', 'error');
      } finally {
        fbdEventSubmitBtn.disabled = false;
        if (mode !== 'edit') fbdEventSubmitBtn.textContent = originalText;
      }
    }, true);

    /*************************************************
     * Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª / Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©
     *************************************************/
    window.testFirestoreConnection = async function() {
      const el = document.getElementById('tokenStatusText');
      el.textContent = 'Testing...';
      const r = await firestoreAPI.testConnection();
      el.textContent = r.success ? 'Connected' : `Error: ${r.error}`;
      document.getElementById('tokenStatus').style.background = r.success ? '#f0fff4' : '#fff5f5';
    };

    window.fixFirestoreStructure = async function() {
      const box = document.getElementById('structureResults');
      const content = document.getElementById('structureResultsContent');
      box.style.display = 'block';
      content.innerHTML = '<p>Validating and fixing structure...</p>';
      const r = await firestoreAPI.validateAndFixStructure();
      const actions = (r.actions||[]).map(a=>`<li style="color:#2f855a">âœ“ ${a}</li>`).join('');
      const errors  = (r.errors ||[]).map(e=>`<li style="color:#c53030">âœ— ${e}</li>`).join('');
      content.innerHTML = `<ul>${actions}${errors}</ul>`;
    };

    window.loadAdminsList = async function() {
      const box = document.getElementById('adminsList'); box.innerHTML = '<p>Loading...</p>';
      const r = await firestoreAPI.getAdmins();
      if (!r.success) { box.innerHTML = `<p style="color:red">${r.error}</p>`; return; }
      if ((r.admins||[]).length===0) { box.innerHTML = '<p>No admins found.</p>'; return; }
      box.innerHTML = r.admins.map(a=>`<div class="content-item"><div>${a}</div></div>`).join('');
    };

    /*************************************************
     * END
     *************************************************/
  </script>
</body>
</html>
